<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Day 26 ‚Äî Lambda SOAR: Automated Incident Response</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="shared.css">
</head>
<body>
<div class="shell">
<aside class="sidebar">
  <div class="sidebar-header">
    <div class="day-badge">Week 4 ¬∑ Day 26</div>
    <h2>Lambda SOAR: Automated Incident Response</h2>
    <div class="sidebar-meta"><span class="chip">Advanced</span><span class="chip">4 hours</span><span class="chip">SOAR</span></div>
  </div>
  <div class="sidebar-back">
    <a class="back-index" href="../index.html">
      <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M7.5 2L3.5 6L7.5 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      Course Index
    </a>
    <div class="week-jumps-label">Jump to week</div>
    <div class="week-jumps">
      <a class="week-jump wj1" href="../index.html#week-1">W1</a>
      <a class="week-jump wj2" href="../index.html#week-2">W2</a>
      <a class="week-jump wj3" href="../index.html#week-3">W3</a>
      <a class="week-jump wj4" href="../index.html#week-4">W4</a>
    </div>
    <div class="day-nav-label">Week 4 days</div>
    <div class="day-nav">
      <a class="day-link" href="day-22.html">D22</a>
      <a class="day-link" href="day-23.html">D23</a>
      <a class="day-link" href="day-24.html">D24</a>
      <a class="day-link" href="day-25.html">D25</a>
      <a class="day-link current" href="day-26.html">D26</a>
      <a class="day-link" href="day-27.html">D27</a>
      <a class="day-link" href="day-28.html">D28</a>
    </div>
  </div>

  <nav class="lesson-nav">
    <div class="nav-group-label">Lessons</div>
    <div class="nav-item active" onclick="goTo(0)"><span class="nav-num">1</span><span class="nav-label">SOAR: The Automation Philosophy</span><span class="nav-check">‚úì</span></div>
    <div class="nav-item" onclick="goTo(1)"><span class="nav-num">2</span><span class="nav-label">The EventBridge ‚Üí Lambda Pattern</span><span class="nav-check">‚úì</span></div>
    <div class="nav-item" onclick="goTo(2)"><span class="nav-num">3</span><span class="nav-label">Idempotency: Critical for Automation</span><span class="nav-check">‚úì</span></div>
    <div class="nav-item" onclick="goTo(3)"><span class="nav-num">4</span><span class="nav-label">What to Automate vs. Gate</span><span class="nav-check">‚úì</span></div>
    <div class="nav-group-label">Lab</div>
    <div class="nav-item lab-item" onclick="goTo(4)"><span class="nav-num">5</span><span class="nav-label">Hands-on: Deploy the SOAR Pipeline</span><span class="nav-check">‚úì</span></div>
  </nav>
  <div class="sidebar-footer">
    <div class="progress-label"><span>Day progress</span><span id="progress-pct">0 / 5</span></div>
    <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
  </div>
</aside>
<main class="main">
  <div class="lesson-topbar">
    <div class="lesson-crumb">Week 4 &nbsp;/&nbsp; <span id="topbar-title">SOAR: The Automation Philosophy</span></div>
    <div class="nav-arrows">
      <button class="arrow-btn" id="btn-prev" onclick="prev()" disabled>‚Üê Prev</button>
      <button class="arrow-btn" id="btn-next" onclick="next()">Next ‚Üí</button>
    </div>
  </div>

  <!-- PANE 0 -->
  <div class="lesson-pane active" id="pane-0">
    <div class="lesson-tag tag-detect">‚ö° Automation</div>
    <h1>SOAR: The<br><em>Automation Philosophy</em></h1>
    <p>Manual incident response has a fundamental scaling problem. A security team receiving 500 findings per day cannot meaningfully triage each one. Most findings are noise, some are real but low-priority, and a few are critical ‚Äî but by the time a human reviews the queue, hours have passed.</p>
    <p><strong>SOAR</strong> (Security Orchestration, Automation and Response) addresses this by automating the response to well-understood, high-confidence finding types. The philosophy rests on three principles:</p>
    <div class="callout tip">
      <div class="callout-title">‚ö° Automate the Obvious</div>
      A public S3 bucket should never exist in a production account. If Config or Security Hub finds one, the correct action is always the same: make it private, notify the team, create a ticket. This requires no human judgement ‚Äî automate it completely.
    </div>
    <div class="callout insight">
      <div class="callout-title">üß† Accelerate the Complex</div>
      A GuardDuty finding suggesting credential compromise requires human investigation. But you can automate the first containment step: disable the credentials, capture the session data, create a high-priority ticket. The analyst starts an investigation, not a firefighting exercise.
    </div>
    <div class="callout warning">
      <div class="callout-title">üìä Measure What You Automate</div>
      Track MTTD (Mean Time to Detect) and MTTR (Mean Time to Respond) separately for automated vs. manual responses. Automation should drive MTTR from hours to seconds for covered finding types.
    </div>
    <p>The goal isn't to automate everything ‚Äî it's to eliminate the human bottleneck for the findings that don't require human judgement, so your team has capacity to focus on the ones that do.</p>
    <div class="kcheck" id="pane-0-quiz">
      <div class="kcheck-label">Knowledge Check</div>
      <div class="kcheck-q">Your SOAR pipeline auto-remediates 200 low/medium findings per week. Your team of 3 analysts also receives 30 high/critical findings per week that require manual investigation. After deploying SOAR, what is the most important operational change?</div>
      <div class="kcheck-options">
        <button class="kcheck-opt" onclick="check(this,false,0)">Reduce the team from 3 analysts to 1 since SOAR handles most findings automatically.</button>
        <button class="kcheck-opt" onclick="check(this,true,0)">Redirect the freed analyst capacity toward investigating the 30 high/critical findings with greater depth and speed ‚Äî improving MTTR on the findings that actually matter.</button>
        <button class="kcheck-opt" onclick="check(this,false,0)">Expand SOAR to also automate the 30 high/critical findings to eliminate manual work entirely.</button>
        <button class="kcheck-opt" onclick="check(this,false,0)">Turn off GuardDuty since SOAR handles S3 findings and GuardDuty creates alert fatigue.</button>
      </div>
      <div class="kcheck-feedback" id="fb-0"></div>
    </div>
    <div class="lesson-nav-footer"><button class="prev-btn" onclick="prev()" disabled>‚Üê Previous</button><button class="next-btn" onclick="next()">Next ‚Üí</button></div>
  </div>

  <!-- PANE 1 -->
  <div class="lesson-pane" id="pane-1">
    <div class="lesson-tag tag-arch">üîÅ Architecture</div>
    <h1>The EventBridge ‚Üí<br><em>Lambda Pattern</em></h1>
    <p>AWS SOAR is built on a two-layer architecture: EventBridge for routing, Lambda for execution. Security services generate findings; EventBridge watches for matching patterns and triggers the right Lambda for each finding type.</p>
    <div class="flow-diagram">
<span class="node">Security Hub / GuardDuty / Config</span><br>
<span class="arrow">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îÇ generates finding</span><br>
<span class="arrow">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚ñº</span><br>
<span class="node">EventBridge</span> <span class="comment">(event bus ‚Äî rule matches finding type + severity)</span><br>
<span class="arrow">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îÇ</span><br>
<span class="arrow">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚ñº</span><br>
<span class="node">Lambda Function</span> <span class="comment">(remediation logic)</span><br>
<span class="action">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îú‚îÄ‚îÄ Remediate the resource (S3 private, IAM key disabled)</span><br>
<span class="action">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îú‚îÄ‚îÄ Send SNS notification (Slack / email / PagerDuty)</span><br>
<span class="action">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îî‚îÄ‚îÄ Update Security Hub finding ‚Üí RESOLVED</span>
    </div>
    <h2>EventBridge Event Pattern</h2>
    <p>EventBridge rules match on JSON event patterns. For Security Hub findings, you can filter by finding type, severity, workflow status, and record state ‚Äî routing only the right findings to each Lambda:</p>
    <div class="code-block"><div class="code-header"><span class="code-lang">json ‚Äî EventBridge rule pattern</span><button class="copy-btn" onclick="copyCode(this)">copy</button></div><pre>{
  <span class="key">"source"</span>: [<span class="str">"aws.securityhub"</span>],
  <span class="key">"detail-type"</span>: [<span class="str">"Security Hub Findings - Imported"</span>],
  <span class="key">"detail"</span>: {
    <span class="key">"findings"</span>: {
      <span class="key">"GeneratorId"</span>: [<span class="str">"aws-foundational-security-best-practices/v/1.0.0/S3.2"</span>],
      <span class="key">"Workflow"</span>: {<span class="key">"Status"</span>: [<span class="str">"NEW"</span>]},
      <span class="key">"RecordState"</span>: [<span class="str">"ACTIVE"</span>]
    }
  }
}</pre></div>
    <p>This pattern fires only for S3.2 findings (public S3 bucket with public read access) that are new and active ‚Äî not for resolved, suppressed, or already-handled findings. You can add multiple GeneratorIds to route several finding types to the same Lambda.</p>
    <div class="callout tip">
      <div class="callout-title">üí° One Lambda per Finding Type</div>
      Keep each Lambda focused on one remediation type. A single "remediate everything" Lambda becomes a complex, fragile system. Separate Lambdas for S3, GuardDuty credential findings, and Config rules are easier to test, debug, and update independently.
    </div>
    <div class="kcheck" id="pane-1-quiz">
      <div class="kcheck-label">Knowledge Check</div>
      <div class="kcheck-q">Your EventBridge rule fires for Security Hub S3.2 findings. The same finding arrives twice within 30 seconds (EventBridge at-least-once delivery). Your Lambda runs twice. What happens if the first execution already made the bucket private?</div>
      <div class="kcheck-options">
        <button class="kcheck-opt" onclick="check(this,false,1)">The second execution fails with an S3 error because the bucket is already private.</button>
        <button class="kcheck-opt" onclick="check(this,false,1)">The second execution makes the bucket public again before making it private ‚Äî causing a brief exposure window.</button>
        <button class="kcheck-opt" onclick="check(this,true,1)">If the Lambda is idempotent, it checks the current state first, finds the bucket already private, and exits cleanly with no error and no side effects.</button>
        <button class="kcheck-opt" onclick="check(this,false,1)">EventBridge guarantees exactly-once delivery so this situation cannot occur.</button>
      </div>
      <div class="kcheck-feedback" id="fb-1"></div>
    </div>
    <div class="lesson-nav-footer"><button class="prev-btn" onclick="prev()">‚Üê Previous</button><button class="next-btn" onclick="next()">Next ‚Üí</button></div>
  </div>

  <!-- PANE 2 -->
  <div class="lesson-pane" id="pane-2">
    <div class="lesson-tag tag-concept">üîÑ Reliability</div>
    <h1>Idempotency:<br><em>Critical for Automation</em></h1>
    <p>Idempotency means: running the same operation twice produces the same result as running it once, with no error and no unintended side effects. It is the single most important property for automated remediation code.</p>
    <p>EventBridge delivers events at-least-once. Lambda can retry on errors. Your remediation might run two, three, or more times for a single finding. Without idempotency, duplicate executions can cause failures, noise, or ‚Äî worst of all ‚Äî brief re-exposure of a resource between the check and the remediation.</p>
    <h2>The Idempotent Pattern</h2>
    <div class="code-block"><div class="code-header"><span class="code-lang">python ‚Äî idempotent S3 remediation</span><button class="copy-btn" onclick="copyCode(this)">copy</button></div><pre><span class="kw">def</span> <span class="hl">make_bucket_private</span>(bucket_name):
    <span class="comment"># 1. Check current state FIRST</span>
    current = s3.get_public_access_block(Bucket=bucket_name)
    cfg = current[<span class="str">'PublicAccessBlockConfiguration'</span>]

    already_private = <span class="hl2">all</span>([
        cfg.get(<span class="str">'BlockPublicAcls'</span>, <span class="kw">False</span>),
        cfg.get(<span class="str">'BlockPublicPolicy'</span>, <span class="kw">False</span>),
        cfg.get(<span class="str">'IgnorePublicAcls'</span>, <span class="kw">False</span>),
        cfg.get(<span class="str">'RestrictPublicBuckets'</span>, <span class="kw">False</span>),
    ])

    <span class="kw">if</span> already_private:
        <span class="comment"># 2. Idempotent exit ‚Äî no action, no error</span>
        logger.info(<span class="str">"Bucket %s already private ‚Äî no action"</span>, bucket_name)
        <span class="kw">return</span>

    <span class="comment"># 3. Only remediate if actually needed</span>
    s3.put_public_access_block(
        Bucket=bucket_name,
        PublicAccessBlockConfiguration={
            <span class="str">'BlockPublicAcls'</span>: <span class="kw">True</span>,
            <span class="str">'IgnorePublicAcls'</span>: <span class="kw">True</span>,
            <span class="str">'BlockPublicPolicy'</span>: <span class="kw">True</span>,
            <span class="str">'RestrictPublicBuckets'</span>: <span class="kw">True</span>,
        }
    )
    logger.info(<span class="str">"‚úÖ Remediated: %s"</span>, bucket_name)</pre></div>
    <p>The pattern is always: <strong>check ‚Üí decide ‚Üí act</strong>, never <strong>act ‚Üí check</strong>. The check must happen atomically with the decision ‚Äî you can't check at the start of the function and act at the end if there's any async work in between.</p>
    <div class="callout warning">
      <div class="callout-title">‚ö†Ô∏è Not Just for Lambda</div>
      Idempotency matters for any automated remediation ‚Äî CloudFormation stack updates, SSM Automation runbooks, Step Functions workflows. If your automation can run twice on the same resource, it must be designed to handle that gracefully.
    </div>
    <div class="kcheck" id="pane-2-quiz">
      <div class="kcheck-label">Knowledge Check</div>
      <div class="kcheck-q">You write a Lambda that responds to GuardDuty findings by disabling the associated IAM access key. A key is already disabled when the Lambda runs a second time. Which response is correct for an idempotent implementation?</div>
      <div class="kcheck-options">
        <button class="kcheck-opt" onclick="check(this,false,2)">Call <code>UpdateAccessKey(Status=Inactive)</code> regardless ‚Äî AWS will silently ignore it if already inactive.</button>
        <button class="kcheck-opt" onclick="check(this,true,2)">Check the key status with <code>ListAccessKeys</code> first ‚Äî if already Inactive, log "already disabled" and return successfully without calling <code>UpdateAccessKey</code>.</button>
        <button class="kcheck-opt" onclick="check(this,false,2)">Raise an exception to prevent the duplicate execution from completing.</button>
        <button class="kcheck-opt" onclick="check(this,false,2)">Re-enable the key and disable it again to ensure the action is logged in CloudTrail.</button>
      </div>
      <div class="kcheck-feedback" id="fb-2"></div>
    </div>
    <div class="lesson-nav-footer"><button class="prev-btn" onclick="prev()">‚Üê Previous</button><button class="next-btn" onclick="next()">Next ‚Üí</button></div>
  </div>

  <!-- PANE 3 -->
  <div class="lesson-pane" id="pane-3">
    <div class="lesson-tag tag-security">üö¶ Decision Framework</div>
    <h1>What to Automate<br><em>vs. Gate</em></h1>
    <p>Automation without human review is a force multiplier ‚Äî but only if the automation is correct. The wrong remediation applied automatically can be worse than no remediation: it can mask a real incident, break a legitimate service, or trigger a false sense of security.</p>
    <p>The decision to fully automate, auto-contain + escalate, or alert only depends on one question: <strong>is there any legitimate reason this finding could be a false positive?</strong></p>
    <table class="styled-table">
      <thead><tr><th>Finding Type</th><th>Automation Level</th><th>Reason</th></tr></thead>
      <tbody>
        <tr><td>Public S3 bucket</td><td>Full auto-remediation</td><td>Always wrong in production ‚Äî zero false positives</td></tr>
        <tr><td>Unencrypted S3 bucket</td><td>Auto-notify + ticket</td><td>Might have a legacy migration reason ‚Äî needs review</td></tr>
        <tr><td>GuardDuty credential compromise</td><td>Auto-contain + escalate</td><td>Contains blast radius, then human investigates</td></tr>
        <tr><td>Root account usage</td><td>Auto-alert only</td><td>Rare but sometimes legitimate ‚Äî don't auto-disable root</td></tr>
        <tr><td>CloudTrail disabled</td><td>Auto-re-enable + page oncall</td><td>Attackers cover tracks ‚Äî respond aggressively</td></tr>
        <tr><td>New admin IAM user</td><td>Auto-alert + require approval</td><td>Could be a legitimate new hire provisioning</td></tr>
      </tbody>
    </table>
    <div class="callout insight">
      <div class="callout-title">üí° The General Rule</div>
      Automate when there are no legitimate false positives in your environment. Gate when there might be a valid business reason that automation can't distinguish. Always document why you chose each automation level ‚Äî the reasoning matters more than the decision.
    </div>
    <div class="kcheck" id="pane-3-quiz">
      <div class="kcheck-label">Knowledge Check</div>
      <div class="kcheck-q">GuardDuty fires a <code>UnauthorizedAccess:IAMUser/TorIPCaller</code> finding. An engineer says "we should auto-disable the IAM key immediately." A senior engineer says "we should auto-alert and require human approval before disabling." Who is right, and why?</div>
      <div class="kcheck-options">
        <button class="kcheck-opt" onclick="check(this,false,3)">The first engineer ‚Äî Tor IP findings are always malicious and immediate auto-disable is the correct response.</button>
        <button class="kcheck-opt" onclick="check(this,true,3)">The senior engineer ‚Äî some developers legitimately route traffic through Tor for privacy. Auto-disabling could break a legitimate workflow. Auto-contain (disable key) + immediate human review is safer than pure alert-only or pure auto-remediation.</button>
        <button class="kcheck-opt" onclick="check(this,false,3)">Neither ‚Äî GuardDuty Tor findings should be permanently suppressed as they always represent privacy-conscious developers.</button>
        <button class="kcheck-opt" onclick="check(this,false,3)">The first engineer ‚Äî MTTR targets require automated response for all High and Critical findings without exception.</button>
      </div>
      <div class="kcheck-feedback" id="fb-3"></div>
    </div>
    <div class="lesson-nav-footer"><button class="prev-btn" onclick="prev()">‚Üê Previous</button><button class="next-btn" onclick="next()">Next ‚Üí</button></div>
  </div>

  <!-- PANE 4 ‚Äî Lab -->
  <div class="lesson-pane lab-pane" id="pane-4">
    <div class="lesson-tag tag-lab">üî¨ Hands-on Lab</div>
    <h1>Deploy the<br><em>SOAR Pipeline</em></h1>
    <p>Build a complete EventBridge ‚Üí Lambda SOAR pipeline that auto-remediates public S3 buckets. Detection to remediation in under 30 seconds.</p>
    <div class="callout lab-note"><div class="callout-title">‚ö° Cost</div>Lambda has no cost when not invoked. EventBridge rules have no cost when not firing. The SOAR pipeline is effectively free until it actually remediates something.</div>
    <div class="lab-steps">
      <div class="lab-step">
        <div class="step-num-wrap"><div class="step-num">1</div><div class="step-connector"></div></div>
        <div class="step-content">
          <div class="step-title">Create the Lambda IAM Role <span style="font-size:12px;color:var(--muted);font-family:'IBM Plex Mono',monospace">~10 min</span></div>
          <div class="step-body">
            <div class="code-block"><div class="code-header"><span class="code-lang">bash</span><button class="copy-btn" onclick="copyCode(this)">copy</button></div><pre>ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

aws iam create-role \
  --role-name SOARRemediationRole \
  --assume-role-policy-document <span class="str">'{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Principal":{"Service":"lambda.amazonaws.com"},"Action":"sts:AssumeRole"}]}'</span>

aws iam put-role-policy \
  --role-name SOARRemediationRole \
  --policy-name SOARRemediationPolicy \
  --policy-document <span class="str">'{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":["s3:GetBucketPublicAccessBlock","s3:PutPublicAccessBlock","securityhub:BatchUpdateFindings","sns:Publish","logs:CreateLogGroup","logs:CreateLogStream","logs:PutLogEvents"],"Resource":"*"}]}'</span>

echo <span class="str">"‚úÖ IAM role created"</span></pre></div>
          </div>
        </div>
      </div>
      <div class="lab-step">
        <div class="step-num-wrap"><div class="step-num">2</div><div class="step-connector"></div></div>
        <div class="step-content">
          <div class="step-title">Deploy the Remediation Lambda <span style="font-size:12px;color:var(--muted);font-family:'IBM Plex Mono',monospace">~15 min</span></div>
          <div class="step-body">
            <p>Save the full Python source from <code>week-4/labs/soar_remediation.py</code> to <code>/tmp/soar_remediation.py</code>, then deploy:</p>
            <div class="code-block"><div class="code-header"><span class="code-lang">bash</span><button class="copy-btn" onclick="copyCode(this)">copy</button></div><pre>cd /tmp && zip soar_remediation.zip soar_remediation.py

SNS_ARN=$(aws sns list-topics \
  --query <span class="str">"Topics[0].TopicArn"</span> --output text)

aws lambda create-function \
  --function-name soar-s3-remediation \
  --runtime python3.12 \
  --role <span class="str">"arn:aws:iam::${ACCOUNT_ID}:role/SOARRemediationRole"</span> \
  --handler soar_remediation.lambda_handler \
  --zip-file fileb:///tmp/soar_remediation.zip \
  --environment <span class="str">"Variables={SNS_TOPIC_ARN=${SNS_ARN}}"</span> \
  --timeout 30 --memory-size 128

echo <span class="str">"‚úÖ Lambda deployed"</span></pre></div>
          </div>
        </div>
      </div>
      <div class="lab-step">
        <div class="step-num-wrap"><div class="step-num">3</div><div class="step-connector"></div></div>
        <div class="step-content">
          <div class="step-title">Create the EventBridge Rule & Wire the Target <span style="font-size:12px;color:var(--muted);font-family:'IBM Plex Mono',monospace">~10 min</span></div>
          <div class="step-body">
            <div class="code-block"><div class="code-header"><span class="code-lang">bash</span><button class="copy-btn" onclick="copyCode(this)">copy</button></div><pre>aws events put-rule \
  --name <span class="str">"SecurityHub-S3-PublicAccess-Remediation"</span> \
  --event-pattern <span class="str">'{"source":["aws.securityhub"],"detail-type":["Security Hub Findings - Imported"],"detail":{"findings":{"GeneratorId":["aws-foundational-security-best-practices/v/1.0.0/S3.2"],"Workflow":{"Status":["NEW"]},"RecordState":["ACTIVE"]}}}'</span> \
  --state ENABLED

RULE_ARN=$(aws events describe-rule \
  --name SecurityHub-S3-PublicAccess-Remediation \
  --query <span class="str">"Arn"</span> --output text)

LAMBDA_ARN=$(aws lambda get-function \
  --function-name soar-s3-remediation \
  --query <span class="str">"Configuration.FunctionArn"</span> --output text)

aws events put-targets \
  --rule SecurityHub-S3-PublicAccess-Remediation \
  --targets <span class="str">"Id=SoarLambda,Arn=${LAMBDA_ARN}"</span>

aws lambda add-permission \
  --function-name soar-s3-remediation \
  --statement-id EventBridgeInvoke \
  --action lambda:InvokeFunction \
  --principal events.amazonaws.com \
  --source-arn <span class="str">"$RULE_ARN"</span>

echo <span class="str">"‚úÖ EventBridge rule wired to Lambda"</span></pre></div>
          </div>
        </div>
      </div>
      <div class="lab-step">
        <div class="step-num-wrap"><div class="step-num">4</div></div>
        <div class="step-content">
          <div class="step-title">Test End-to-End with a Synthetic Event <span style="font-size:12px;color:var(--muted);font-family:'IBM Plex Mono',monospace">~10 min</span></div>
          <div class="step-body">
            <div class="code-block"><div class="code-header"><span class="code-lang">bash</span><button class="copy-btn" onclick="copyCode(this)">copy</button></div><pre>REGION=$(aws configure get region)

cat > /tmp/test-event.json << EOF
{
  "detail": {
    "findings": [{
      "Id": "arn:aws:securityhub:${REGION}:${ACCOUNT_ID}:test/finding/001",
      "ProductArn": "arn:aws:securityhub:${REGION}::product/aws/securityhub",
      "GeneratorId": "aws-foundational-security-best-practices/v/1.0.0/S3.2",
      "Resources": [{"Type": "AwsS3Bucket","Id": "arn:aws:s3:::lab-encrypted-data-${ACCOUNT_ID}"}],
      "Workflow": {"Status": "NEW"},
      "RecordState": "ACTIVE"
    }]
  }
}
EOF

aws lambda invoke \
  --function-name soar-s3-remediation \
  --payload file:///tmp/test-event.json \
  /tmp/soar-output.json

cat /tmp/soar-output.json

<span class="comment"># Check logs</span>
aws logs tail /aws/lambda/soar-s3-remediation --since 5m

git add screenshots/day-26-*.png
git commit -m <span class="str">"Day 26: SOAR pipeline ‚Äî EventBridge + Lambda S3 auto-remediation deployed and tested"</span>
git push</pre></div>
            <p>Expected output: <code>remediated</code> or <code>already_compliant</code> ‚Äî either is correct and confirms the idempotent logic works.</p>
          </div>
        </div>
      </div>
    </div>
    <h2 style="font-family:'DM Serif Display',serif;font-size:20px;color:#e4eaf6;margin:32px 0 16px;font-weight:400">Lab Checklist</h2>
    <div class="checklist-progress"><div class="checklist-progress-bar"><div class="checklist-progress-fill" id="cl-fill"></div></div><span class="checklist-progress-label" id="cl-label">0 / 8</span></div>
    <div class="checklist">
      <div class="check-item" onclick="toggleCheck(this,0)"><div class="check-box">‚úì</div><div class="check-text"><code>SOARRemediationRole</code> created with least-privilege permissions</div></div>
      <div class="check-item" onclick="toggleCheck(this,1)"><div class="check-box">‚úì</div><div class="check-text"><code>soar-s3-remediation</code> Lambda deployed with SNS_TOPIC_ARN environment variable</div></div>
      <div class="check-item" onclick="toggleCheck(this,2)"><div class="check-box">‚úì</div><div class="check-text">EventBridge rule <code>SecurityHub-S3-PublicAccess-Remediation</code> created and ENABLED</div></div>
      <div class="check-item" onclick="toggleCheck(this,3)"><div class="check-box">‚úì</div><div class="check-text">Lambda target attached to EventBridge rule ‚Äî <code>add-permission</code> granted</div></div>
      <div class="check-item" onclick="toggleCheck(this,4)"><div class="check-box">‚úì</div><div class="check-text">End-to-end test invoked ‚Äî output shows <code>remediated</code> or <code>already_compliant</code></div></div>
      <div class="check-item" onclick="toggleCheck(this,5)"><div class="check-box">‚úì</div><div class="check-text">CloudWatch Logs show successful execution trace with no errors</div></div>
      <div class="check-item" onclick="toggleCheck(this,6)"><div class="check-box">‚úì</div><div class="check-text">Screenshot: EventBridge rule console showing Lambda target</div></div>
      <div class="check-item" onclick="toggleCheck(this,7)"><div class="check-box">‚úì</div><div class="check-text">Screenshot: Lambda test output + CloudWatch log confirmation</div></div>
    </div>
    <div class="lesson-nav-footer"><button class="prev-btn" onclick="prev()">‚Üê Previous</button><button class="next-btn lab-btn" onclick="finish()">Complete Day 26 ‚úì</button></div>
  </div>

  <!-- COMPLETION -->
  <div class="lesson-pane" id="pane-complete">
    <div class="completion-card">
      <span class="completion-icon">‚ö°</span>
      <h1>Day 26 Complete</h1>
      <p>Detection to remediation in under 30 seconds ‚Äî your SOAR pipeline is live. Tomorrow: ScoutSuite external assessment and risk prioritisation ‚Äî adding business context to everything you've built.</p>
      <div class="score-pill"><span>‚ö°</span> Quiz: <span id="score-val">‚Äî</span></div><br>
      <div class="lab-score-pill"><span>üî¨</span> Lab: <span id="lab-score-val">‚Äî</span> complete</div>
      <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
        <a href="day-25.html" style="text-decoration:none"><button class="prev-btn">‚Üê Day 25</button></a>
        <a href="day-27.html" style="text-decoration:none"><button class="next-btn">Day 27 ‚Üí</button></a>
      </div>
    </div>
  </div>
</main>
</div>
<script src="csm-core.js"></script>
<script>
initPage({
  storageKey: 'csm-day26',
  total: 5,
  quizCount: 4,
  checkTotal: 8,
  titles: ['SOAR: The Automation Philosophy','The EventBridge ‚Üí Lambda Pattern','Idempotency: Critical for Automation','What to Automate vs. Gate','Hands-on: Deploy the SOAR Pipeline'],
  fb: {
  0:{good:"Correct. The value of SOAR isn't headcount reduction ‚Äî it's capacity reallocation. 200 low/medium findings consuming analyst time every week is 200 opportunities for a real High/Critical finding to sit unreviewed. SOAR eliminates that queue, freeing three analysts to focus entirely on the 30 findings that actually require human judgement, investigation, and decision-making. The quality and speed of response to genuinely serious findings improves dramatically.",bad:"Not quite. SOAR's primary value is not eliminating analyst roles or removing human oversight from complex findings. The 30 high/critical findings still need human investigation ‚Äî they involve credential compromise, active threats, and decisions that require context only a human can provide. The correct value proposition: SOAR handles the 200 routine findings automatically, freeing your team's full capacity for the 30 that genuinely matter."},
  1:{good:"Correct. EventBridge provides at-least-once delivery ‚Äî the same event can arrive more than once. An idempotent Lambda handles this gracefully: it checks the current state of the bucket, finds it already private (from the first execution), logs that no action is needed, and exits cleanly. No error, no noise, no side effects. This is the expected and correct behaviour ‚Äî the pipeline appears to work exactly once even though it ran twice.",bad:"Not quite. EventBridge guarantees at-least-once delivery, not exactly-once ‚Äî duplicate events are a normal occurrence, not an edge case to be eliminated. An S3 PutPublicAccessBlock call on an already-private bucket doesn't raise an error by default, but relying on that silent behaviour isn't idempotency ‚Äî it's hoping the API doesn't change. True idempotency means explicitly checking state before acting, so the function's behaviour is deterministic regardless of how many times it runs."},
  2:{good:"Correct. This is the check-first idempotent pattern applied to IAM. Call ListAccessKeys to get the current status of the key. If Status is already Inactive, log 'already disabled' and return successfully ‚Äî no call to UpdateAccessKey, no noise in CloudTrail from a redundant operation, no risk of an unintended side effect. The function completes successfully either way, and the second execution is indistinguishable from the first in terms of outcome.",bad:"Not quite. While calling UpdateAccessKey(Status=Inactive) on an already-inactive key may silently succeed, it's not true idempotency ‚Äî it relies on the API's implementation detail rather than explicitly checking state. This creates unnecessary CloudTrail entries (a second UpdateAccessKey event), adds latency, and may fail if the key doesn't exist. Raising an exception prevents the function from completing, which causes Lambda retries. Re-enabling and disabling is a brief re-exposure and should never be done."},
  3:{good:"Correct. Tor IP findings have a meaningful false positive rate ‚Äî some developers and security researchers legitimately route traffic through Tor for privacy. Auto-disabling a key without human review could break a legitimate workflow and cause more disruption than the incident response is worth. The right level is auto-contain (disable the key to stop potential misuse) plus immediate human review to confirm whether this is a real incident or a legitimate use case. This balances speed of containment with accuracy of response.",bad:"Not quite. Tor IP findings are not always malicious ‚Äî some developers legitimately use Tor for privacy. Auto-disabling keys without review has a meaningful false positive rate that can break legitimate workflows. But permanently suppressing Tor findings would hide real attacker activity. The correct level is auto-contain (disable key, capture session data) + immediate human escalation for review. This contains the blast radius of a real compromise while preserving the ability to quickly re-enable the key if it's a false positive."}
}
});
</script>
</body>
</html>
