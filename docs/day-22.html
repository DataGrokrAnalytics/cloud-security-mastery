<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Day 22 ‚Äî CloudTrail + SIEM Foundation</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="shared.css">
</head>
<body>
<div class="shell">
<nav class="sidebar">
  <div class="sidebar-header">
    <div class="day-badge">Week 4 ¬∑ Day 22</div>
    <h2>CloudTrail +<br>SIEM Foundation</h2>
    <div class="sidebar-meta"><span class="chip">CloudTrail</span><span class="chip">CloudWatch</span><span class="chip">SIEM</span><span class="chip">4 lessons</span><span class="chip">1 lab</span></div>
  </div>
  <div class="sidebar-back">
    <a class="back-index" href="../index.html">
      <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M7.5 2L3.5 6L7.5 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      Course Index
    </a>
    <div class="week-jumps-label">Jump to week</div>
    <div class="week-jumps">
      <a class="week-jump wj1" href="../index.html#week-1">W1</a>
      <a class="week-jump wj2" href="../index.html#week-2">W2</a>
      <a class="week-jump wj3" href="../index.html#week-3">W3</a>
      <a class="week-jump wj4" href="../index.html#week-4">W4</a>
    </div>
    <div class="day-nav-label">Week 4 days</div>
    <div class="day-nav">
      <a class="day-link current" href="day-22.html">D22</a>
      <a class="day-link" href="day-23.html">D23</a>
      <a class="day-link" href="day-24.html">D24</a>
      <a class="day-link" href="day-25.html">D25</a>
      <a class="day-link" href="day-26.html">D26</a>
      <a class="day-link" href="day-27.html">D27</a>
      <a class="day-link" href="day-28.html">D28</a>
    </div>
  </div>

  <div class="lesson-nav">
    <div class="nav-group-label">Lessons</div>
    <div class="nav-item active" onclick="goTo(0)"><span class="nav-num">01</span><span class="nav-label">Why Logging Is Your Security Brain</span><span class="nav-check">‚úì</span></div>
    <div class="nav-item" onclick="goTo(1)"><span class="nav-num">02</span><span class="nav-label">CloudTrail: The AWS API Audit Log</span><span class="nav-check">‚úì</span></div>
    <div class="nav-item" onclick="goTo(2)"><span class="nav-num">03</span><span class="nav-label">CloudWatch Logs Insights: Querying at Scale</span><span class="nav-check">‚úì</span></div>
    <div class="nav-item" onclick="goTo(3)"><span class="nav-num">04</span><span class="nav-label">Detection Engineering: Alarms & Metrics</span><span class="nav-check">‚úì</span></div>
    <div class="nav-group-label" style="margin-top:8px">Lab</div>
    <div class="nav-item lab-item" onclick="goTo(4)"><span class="nav-num" style="color:var(--lab)">üî¨</span><span class="nav-label">Hands-on: Multi-Region Trail + SIEM Dashboard</span><span class="nav-check">‚úì</span></div>
  </div>
  <div class="sidebar-footer">
    <div class="progress-label"><span>Progress</span><span id="progress-pct">0 / 5</span></div>
    <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
  </div>
</nav>
<div class="main">
  <div class="lesson-topbar">
    <div class="lesson-crumb">Day 22 &nbsp;/&nbsp; <span id="topbar-title">Why Logging Is Your Security Brain</span></div>
    <div class="nav-arrows">
      <button class="arrow-btn" id="btn-prev" onclick="prev()" disabled>‚Üê Prev</button>
      <button class="arrow-btn" id="btn-next" onclick="next()">Next ‚Üí</button>
    </div>
  </div>

  <!-- LESSON 1 -->
  <div class="lesson-pane active" id="pane-0">
    <div class="lesson-tag tag-security">Detection ¬∑ Foundational</div>
    <h1>Why Logging Is<br><em>Your Security Brain</em></h1>
    <p><strong>Objective:</strong> Understand why centralised logging is the foundation of every security operation ‚Äî you cannot detect, investigate, or prove what you cannot see. Learn what CloudTrail captures and why it's irreplaceable.</p>
    <p>Every other control in this programme ‚Äî IAM, VPC, KMS, Macie, Inspector ‚Äî creates a preventive boundary. Logging is different: it answers the question <strong>"what actually happened?"</strong> It's the difference between knowing you were breached and knowing when, how, by whom, and what they touched.</p>
    <div class="callout breach">
      <div class="callout-title">‚ö† Real Breach ‚Äî Capital One (2019)</div>
      A misconfigured WAF allowed a former AWS employee to exploit an SSRF vulnerability and obtain EC2 instance metadata credentials. She exfiltrated 106 million customer records from S3 over several days. The breach was only discovered when someone reported it externally ‚Äî not by Capital One's own monitoring. CloudTrail was enabled, but nobody had built alerts on the unusual GetObject volume or the SSRF-style metadata calls. The logs existed; the detections didn't. $80M fine.
    </div>
    <p>The three questions every security log must answer:</p>
    <div class="flow-steps">
      <div class="flow-step"><div class="flow-num">1</div><div class="flow-body"><strong>Who?</strong> Which identity (IAM user, role, service) performed the action. Without this, you can't attribute activity to a person or a compromise.</div></div>
      <div class="flow-step"><div class="flow-num">2</div><div class="flow-body"><strong>What + When?</strong> Which API call, on which resource, at which exact timestamp. The event name, the resource ARN, and the UTC time are the minimum evidence for any investigation.</div></div>
      <div class="flow-step"><div class="flow-num">3</div><div class="flow-body"><strong>From where?</strong> Source IP address. Distinguishes a developer's laptop from an attacker's VPS ‚Äî and correlates with VPC flow logs and GuardDuty findings.</div></div>
    </div>
    <div class="callout insight">
      <div class="callout-title">üí° Three Log Tiers in AWS</div>
      <strong>CloudTrail</strong> ‚Äî API-level audit: every AWS API call (who called what on which resource). <strong>VPC Flow Logs</strong> ‚Äî network-level: IP traffic accepted/rejected across ENIs. <strong>Application logs</strong> ‚Äî business-level: what your code did. All three together give you complete visibility. Today focuses on CloudTrail and CloudWatch as your SIEM backbone.
    </div>
    <div class="kcheck">
      <div class="kcheck-label">Knowledge Check</div>
      <div class="kcheck-q">CloudTrail is enabled in your account. An attacker uses stolen IAM credentials to call <code>s3:GetObject</code> on your PCI data bucket from a cloud VPS at 3 AM. What does CloudTrail record, and what does it <em>not</em> record?</div>
      <div class="kcheck-options">
        <button class="kcheck-opt" onclick="check(this,false,0)"><span class="opt-key">A</span>CloudTrail records everything including the object content ‚Äî you can reconstruct exactly what data was stolen</button>
        <button class="kcheck-opt" onclick="check(this,true,0)"><span class="opt-key">B</span>CloudTrail records the API call metadata (identity, action, resource ARN, source IP, timestamp) but NOT the object content ‚Äî you know they accessed the file but not what the file contained</button>
        <button class="kcheck-opt" onclick="check(this,false,0)"><span class="opt-key">C</span>CloudTrail only records management events ‚Äî S3 GetObject is a data event and requires separate configuration to log</button>
        <button class="kcheck-opt" onclick="check(this,false,0)"><span class="opt-key">D</span>CloudTrail records nothing for S3 ‚Äî VPC flow logs are needed to detect S3 data access</button>
      </div>
      <div class="kcheck-feedback" id="fb-0"></div>
    </div>
    <div class="lesson-nav-footer"><button class="prev-btn" disabled>‚Üê Previous</button><button class="next-btn" onclick="next()">Next Lesson ‚Üí</button></div>
  </div>

  <!-- LESSON 2 -->
  <div class="lesson-pane" id="pane-1">
    <div class="lesson-tag tag-security">CloudTrail ¬∑ Foundational</div>
    <h1>CloudTrail:<br><em>The AWS API Audit Log</em></h1>
    <p><strong>Objective:</strong> Configure CloudTrail correctly ‚Äî multi-region, with data events, log file validation, and S3 delivery ‚Äî and understand the difference between management events and data events.</p>
    <table class="styled-table">
      <thead><tr><th>Event Type</th><th>What it captures</th><th>Default?</th><th>Cost</th></tr></thead>
      <tbody>
        <tr><td>Management</td><td>Control-plane API calls: CreateBucket, RunInstances, AttachRolePolicy, DeleteTrail</td><td>Yes (free)</td><td>Free</td></tr>
        <tr><td>Data ‚Äî S3</td><td>Object-level: GetObject, PutObject, DeleteObject on S3 buckets you specify</td><td>No</td><td>$0.10/100K events</td></tr>
        <tr><td>Data ‚Äî Lambda</td><td>Function invocations ‚Äî who invoked, with what payload size</td><td>No</td><td>$0.10/100K events</td></tr>
        <tr><td>Insights</td><td>Anomalous API call rate detection (e.g. 10x normal DescribeInstances volume)</td><td>No</td><td>$0.35/100K events</td></tr>
      </tbody>
    </table>
    <div class="callout warning">
      <div class="callout-title">‚ö† Single-Region Trail = Blind Spot</div>
      A trail scoped to one region misses every API call in every other region. Attackers commonly spin up resources in rarely-monitored regions (ap-southeast-2, sa-east-1) to avoid detection. Always create an <strong>organisation-wide multi-region trail</strong> that covers all current and future regions. One trail, delivered to one centralised S3 bucket, covers everything.
    </div>
    <div class="code-block">
      <div class="code-header"><span class="code-lang">bash ‚Äî create hardened multi-region trail</span><button class="copy-btn" onclick="copyCode(this)">copy</button></div>
      <pre><span class="comment"># Create trail: multi-region, log file validation on, management + S3 data events</span>
aws cloudtrail create-trail \
  --name <span class="str">org-security-trail</span> \
  --s3-bucket-name <span class="str">my-cloudtrail-logs-bucket</span> \
  --is-multi-region-trail \
  --enable-log-file-validation \
  --include-global-service-events

<span class="comment"># Start logging</span>
aws cloudtrail start-logging --name <span class="str">org-security-trail</span>

<span class="comment"># Add S3 data events (PutObject + GetObject on all buckets)</span>
aws cloudtrail put-event-selectors \
  --trail-name <span class="str">org-security-trail</span> \
  --event-selectors <span class="str">'[{
    "ReadWriteType": "All",
    "IncludeManagementEvents": true,
    "DataResources": [{
      "Type": "AWS::S3::Object",
      "Values": ["arn:aws:s3:::"]
    }]
  }]'</span></pre>
    </div>
    <div class="callout tip">
      <div class="callout-title">‚úì Protect the Trail Itself</div>
      An attacker's first move after gaining access is often <code>cloudtrail:StopLogging</code> or <code>cloudtrail:DeleteTrail</code> ‚Äî to erase their tracks. Protect the trail with: (1) SCP denying <code>cloudtrail:StopLogging</code> for all non-security roles, (2) S3 Object Lock on the log bucket (WORM ‚Äî can't delete), (3) CloudWatch alarm on <code>StopLogging</code> API calls. The alarm from lesson 4 covers this.
    </div>
    <div class="kcheck">
      <div class="kcheck-label">Knowledge Check</div>
      <div class="kcheck-q">You enable a multi-region CloudTrail with management events only (default). Three months later you investigate a suspected data breach where someone may have exfiltrated S3 objects. Can you tell from CloudTrail which specific objects were accessed?</div>
      <div class="kcheck-options">
        <button class="kcheck-opt" onclick="check(this,false,1)"><span class="opt-key">A</span>Yes ‚Äî management events include all S3 operations including object-level reads and writes</button>
        <button class="kcheck-opt" onclick="check(this,true,1)"><span class="opt-key">B</span>No ‚Äî S3 data events (GetObject, PutObject, DeleteObject) require a separate data event selector. Management events only capture bucket-level operations like CreateBucket and PutBucketPolicy</button>
        <button class="kcheck-opt" onclick="check(this,false,1)"><span class="opt-key">C</span>Yes ‚Äî S3 server access logs are automatically forwarded to CloudTrail in multi-region mode</button>
        <button class="kcheck-opt" onclick="check(this,false,1)"><span class="opt-key">D</span>No ‚Äî CloudTrail cannot capture S3 data events regardless of configuration</button>
      </div>
      <div class="kcheck-feedback" id="fb-1"></div>
    </div>
    <div class="lesson-nav-footer"><button class="prev-btn" onclick="prev()">‚Üê Previous</button><button class="next-btn" onclick="next()">Next Lesson ‚Üí</button></div>
  </div>

  <!-- LESSON 3 -->
  <div class="lesson-pane" id="pane-2">
    <div class="lesson-tag tag-siem">CloudWatch Logs Insights ¬∑ Intermediate</div>
    <h1>CloudWatch Logs Insights:<br><em>Querying at Scale</em></h1>
    <p><strong>Objective:</strong> Write Logs Insights queries to hunt for specific threats across CloudTrail logs ‚Äî privilege escalation attempts, cross-region activity, IAM policy changes, and root account usage.</p>
    <p>CloudWatch Logs Insights is your built-in SIEM query engine. CloudTrail delivers JSON logs to a CloudWatch Log Group, and Logs Insights lets you run SQL-like queries across them ‚Äî no external SIEM required for core detection use cases.</p>
    <div class="code-block">
      <div class="code-header"><span class="code-lang">Logs Insights ‚Äî detect root account usage (CRITICAL)</span><button class="copy-btn" onclick="copyCode(this)">copy</button></div>
      <pre><span class="hl">fields</span> @timestamp, eventName, sourceIPAddress, userAgent
<span class="hl">| filter</span> userIdentity.type = <span class="str">"Root"</span>
<span class="hl">| sort</span> @timestamp <span class="hl2">desc</span>
<span class="hl">| limit</span> <span class="key">20</span></pre>
    </div>
    <div class="code-block">
      <div class="code-header"><span class="code-lang">Logs Insights ‚Äî detect IAM privilege escalation attempts</span><button class="copy-btn" onclick="copyCode(this)">copy</button></div>
      <pre><span class="hl">fields</span> @timestamp, eventName, userIdentity.arn, requestParameters
<span class="hl">| filter</span> eventName <span class="hl2">in</span> [
    <span class="str">"AttachUserPolicy"</span>, <span class="str">"AttachRolePolicy"</span>, <span class="str">"PutUserPolicy"</span>,
    <span class="str">"PutRolePolicy"</span>, <span class="str">"CreatePolicyVersion"</span>, <span class="str">"SetDefaultPolicyVersion"</span>,
    <span class="str">"AddUserToGroup"</span>, <span class="str">"CreateLoginProfile"</span>, <span class="str">"UpdateLoginProfile"</span>
  ]
<span class="hl">| sort</span> @timestamp <span class="hl2">desc</span></pre>
    </div>
    <div class="code-block">
      <div class="code-header"><span class="code-lang">Logs Insights ‚Äî detect CloudTrail tampering (attacker evasion)</span><button class="copy-btn" onclick="copyCode(this)">copy</button></div>
      <pre><span class="hl">fields</span> @timestamp, eventName, userIdentity.arn, sourceIPAddress
<span class="hl">| filter</span> eventName <span class="hl2">in</span> [
    <span class="str">"StopLogging"</span>, <span class="str">"DeleteTrail"</span>, <span class="str">"UpdateTrail"</span>,
    <span class="str">"PutEventSelectors"</span>, <span class="str">"DeleteFlowLogs"</span>
  ]
<span class="hl">| sort</span> @timestamp <span class="hl2">desc</span></pre>
    </div>
    <div class="code-block">
      <div class="code-header"><span class="code-lang">Logs Insights ‚Äî top API callers by volume (anomaly baseline)</span><button class="copy-btn" onclick="copyCode(this)">copy</button></div>
      <pre><span class="hl">fields</span> userIdentity.arn, eventName
<span class="hl">| stats</span> <span class="hl2">count</span>(*) <span class="hl">as</span> calls <span class="hl">by</span> userIdentity.arn, eventName
<span class="hl">| sort</span> calls <span class="hl2">desc</span>
<span class="hl">| limit</span> <span class="key">20</span>
<span class="comment">-- Run over 24h window; spikes vs baseline = anomaly signal</span></pre>
    </div>
    <div class="kcheck">
      <div class="kcheck-label">Knowledge Check</div>
      <div class="kcheck-q">Your Logs Insights query for root account usage returns zero results over the past 30 days. A colleague says "great ‚Äî the root account isn't being used." Is this conclusion safe to draw?</div>
      <div class="kcheck-options">
        <button class="kcheck-opt" onclick="check(this,false,2)"><span class="opt-key">A</span>Yes ‚Äî zero results means root account was never used in that period, confirming good security hygiene</button>
        <button class="kcheck-opt" onclick="check(this,true,2)"><span class="opt-key">B</span>Not necessarily ‚Äî the query only returns results if CloudTrail was logging and the logs were delivered to the correct Log Group. If the trail was stopped, the log group was wrong, or data events weren't enabled, there could be unlogged root activity</button>
        <button class="kcheck-opt" onclick="check(this,false,2)"><span class="opt-key">C</span>Yes ‚Äî Logs Insights searches all CloudTrail history regardless of trail configuration</button>
        <button class="kcheck-opt" onclick="check(this,false,2)"><span class="opt-key">D</span>No ‚Äî root account usage is never captured by CloudTrail as it bypasses the API logging layer</button>
      </div>
      <div class="kcheck-feedback" id="fb-2"></div>
    </div>
    <div class="lesson-nav-footer"><button class="prev-btn" onclick="prev()">‚Üê Previous</button><button class="next-btn" onclick="next()">Next Lesson ‚Üí</button></div>
  </div>

  <!-- LESSON 4 -->
  <div class="lesson-pane" id="pane-3">
    <div class="lesson-tag tag-ops">Detection Engineering ¬∑ Intermediate</div>
    <h1>Detection Engineering:<br><em>Alarms & Metrics</em></h1>
    <p><strong>Objective:</strong> Build CloudWatch metric filters and alarms that fire automatically when critical security events occur ‚Äî turning your CloudTrail logs into a real-time detection system.</p>
    <p>Logs Insights is for ad-hoc hunting. <strong>Metric filters + alarms</strong> are for continuous, automated detection ‚Äî they watch the log stream 24/7 and trigger SNS notifications (email, Slack, PagerDuty) within minutes of a detection.</p>
    <div class="callout insight">
      <div class="callout-title">üí° CIS AWS Foundations ‚Äî 15 Required Alarms</div>
      CIS AWS Foundations Benchmark v1.4.0 mandates 15 specific CloudWatch alarms as controls. These are the baseline every cloud security programme must implement. The lab covers the most critical five ‚Äî once you know the pattern, the remaining ten follow the same structure.
    </div>
    <table class="styled-table">
      <thead><tr><th>CIS Control</th><th>Event to detect</th><th>Severity</th></tr></thead>
      <tbody>
        <tr><td>3.1</td><td>Unauthorised API calls (<code>errorCode = "AccessDenied"</code>)</td><td>High</td></tr>
        <tr><td>3.3</td><td>Root account usage (<code>userIdentity.type = "Root"</code>)</td><td>Critical</td></tr>
        <tr><td>3.4</td><td>IAM policy changes (AttachUserPolicy, PutRolePolicy, etc.)</td><td>High</td></tr>
        <tr><td>3.5</td><td>CloudTrail configuration changes (StopLogging, DeleteTrail)</td><td>Critical</td></tr>
        <tr><td>3.10</td><td>Security Group changes (AuthorizeSecurityGroupIngress)</td><td>Medium</td></tr>
      </tbody>
    </table>
    <div class="code-block">
      <div class="code-header"><span class="code-lang">bash ‚Äî root account alarm (CIS 3.3): metric filter ‚Üí alarm ‚Üí SNS</span><button class="copy-btn" onclick="copyCode(this)">copy</button></div>
      <pre><span class="comment"># Step 1: Create metric filter on CloudTrail log group</span>
aws logs put-metric-filter \
  --log-group-name <span class="str">CloudTrail/DefaultLogGroup</span> \
  --filter-name <span class="str">RootAccountUsage</span> \
  --filter-pattern <span class="str">'{ $.userIdentity.type = "Root" && $.userIdentity.invokedBy NOT EXISTS && $.eventType != "AwsServiceEvent" }'</span> \
  --metric-transformations \
    metricName=<span class="str">RootAccountUsageCount</span>,metricNamespace=<span class="str">CISBenchmark</span>,metricValue=<span class="key">1</span>

<span class="comment"># Step 2: Create CloudWatch alarm ‚Äî fires on any root usage</span>
aws cloudwatch put-metric-alarm \
  --alarm-name <span class="str">CIS-3.3-RootAccountUsage</span> \
  --alarm-description <span class="str">"CRITICAL: Root account API call detected"</span> \
  --metric-name <span class="str">RootAccountUsageCount</span> \
  --namespace <span class="str">CISBenchmark</span> \
  --statistic <span class="str">Sum</span> \
  --period <span class="key">300</span> \
  --threshold <span class="key">1</span> \
  --comparison-operator <span class="str">GreaterThanOrEqualToThreshold</span> \
  --evaluation-periods <span class="key">1</span> \
  --alarm-actions <span class="str">arn:aws:sns:us-east-1:123456789:SecurityAlerts</span></pre>
    </div>
    <div class="kcheck">
      <div class="kcheck-label">Knowledge Check</div>
      <div class="kcheck-q">You set the CIS 3.3 root account alarm with a 5-minute evaluation period and threshold of 1. At 2:47 AM, the root account is used to disable MFA. At what time will the alarm fire?</div>
      <div class="kcheck-options">
        <button class="kcheck-opt" onclick="check(this,false,3)"><span class="opt-key">A</span>Immediately at 2:47 AM ‚Äî CloudWatch alarms fire in real-time on each log entry</button>
        <button class="kcheck-opt" onclick="check(this,true,3)"><span class="opt-key">B</span>Between 2:47 and 2:57 AM ‚Äî CloudWatch evaluates the metric at the end of the 5-minute period window, so the alarm fires within ~10 minutes of the event at most</button>
        <button class="kcheck-opt" onclick="check(this,false,3)"><span class="opt-key">C</span>At 3:00 AM ‚Äî CloudWatch alarms only evaluate on the hour boundary</button>
        <button class="kcheck-opt" onclick="check(this,false,3)"><span class="opt-key">D</span>Never ‚Äî root account MFA changes are not captured by CloudTrail management events</button>
      </div>
      <div class="kcheck-feedback" id="fb-3"></div>
    </div>
    <div class="lesson-nav-footer"><button class="prev-btn" onclick="prev()">‚Üê Previous</button><button class="next-btn lab-btn" onclick="next()">Start Lab ‚Üí</button></div>
  </div>

  <!-- LAB -->
  <div class="lesson-pane" id="pane-4">
    <div class="lesson-tag tag-lab">üî¨ Hands-On Lab</div>
    <h1>Multi-Region Trail +<br><em>SIEM Dashboard</em></h1>
    <p>Deploy a production-grade CloudTrail configuration, deliver logs to CloudWatch, build the CIS 3.3 and 3.5 alarms, and create a CloudWatch dashboard as your SIEM home screen.</p>
    <div class="callout lab-note"><div class="callout-title">‚ö° Cost Note</div>CloudTrail: first trail in each region is free. CloudWatch Logs: $0.50/GB ingested ‚Äî trail logs are tiny (&lt;1MB for this lab). CloudWatch alarms: $0.10/alarm/month ‚Äî 2 alarms = $0.20. Total lab cost: &lt;$0.05. Clean up the SNS topic and alarms after ‚Äî the trail itself is free to keep.</div>
    <div class="lab-steps">
      <div class="lab-step">
        <div class="step-num-wrap"><div class="step-num">1</div><div class="step-connector"></div></div>
        <div class="step-content">
          <div class="step-title">Create Multi-Region Trail with CloudWatch Delivery <span style="font-size:12px;color:var(--muted);font-family:'IBM Plex Mono',monospace">~10 min</span></div>
          <div class="step-body">
            <ol>
              <li>CloudTrail Console ‚Üí Create trail ‚Üí Name: <code>security-audit-trail</code></li>
              <li>Apply trail to all regions ‚Üí ‚úì (this is the multi-region toggle)</li>
              <li>Storage: Create new S3 bucket <code>cloudtrail-logs-{account-id}</code> ‚Äî enable SSE-KMS</li>
              <li>CloudWatch Logs ‚Üí Enable ‚Üí New log group: <code>/aws/cloudtrail/security-audit</code></li>
              <li>Management events: Read + Write. Data events: skip for free tier</li>
              <li>Enable log file validation ‚Üí Create trail</li>
            </ol>
          </div>
        </div>
      </div>
      <div class="lab-step">
        <div class="step-num-wrap"><div class="step-num">2</div><div class="step-connector"></div></div>
        <div class="step-content">
          <div class="step-title">Create SNS Alert Topic <span style="font-size:12px;color:var(--muted);font-family:'IBM Plex Mono',monospace">~5 min</span></div>
          <div class="step-body">
            <div class="code-block">
              <div class="code-header"><span class="code-lang">bash</span><button class="copy-btn" onclick="copyCode(this)">copy</button></div>
              <pre><span class="comment"># Create SNS topic for security alerts</span>
aws sns create-topic --name <span class="str">SecurityAlerts</span>

<span class="comment"># Subscribe your email (replace with your address)</span>
aws sns subscribe \
  --topic-arn arn:aws:sns:us-east-1:<span class="hl2">ACCOUNT_ID</span>:SecurityAlerts \
  --protocol email \
  --notification-endpoint <span class="str">you@example.com</span>

<span class="comment"># Confirm the subscription via the email AWS sends you</span></pre>
            </div>
          </div>
        </div>
      </div>
      <div class="lab-step">
        <div class="step-num-wrap"><div class="step-num">3</div><div class="step-connector"></div></div>
        <div class="step-content">
          <div class="step-title">Build CIS 3.3 + 3.5 Alarms <span style="font-size:12px;color:var(--muted);font-family:'IBM Plex Mono',monospace">~15 min</span></div>
          <div class="step-body">
            <p>Use the bash commands from Lesson 4 to create both alarms. Replace <code>CloudTrail/DefaultLogGroup</code> with your log group name <code>/aws/cloudtrail/security-audit</code> and update the SNS ARN. Then build the CloudTrail tampering alarm:</p>
            <div class="code-block">
              <div class="code-header"><span class="code-lang">bash ‚Äî CIS 3.5: CloudTrail configuration changes</span><button class="copy-btn" onclick="copyCode(this)">copy</button></div>
              <pre>aws logs put-metric-filter \
  --log-group-name <span class="str">/aws/cloudtrail/security-audit</span> \
  --filter-name <span class="str">CloudTrailChanges</span> \
  --filter-pattern <span class="str">'{ ($.eventName = CreateTrail) || ($.eventName = UpdateTrail) || ($.eventName = DeleteTrail) || ($.eventName = StartLogging) || ($.eventName = StopLogging) }'</span> \
  --metric-transformations \
    metricName=<span class="str">CloudTrailChangeCount</span>,metricNamespace=<span class="str">CISBenchmark</span>,metricValue=<span class="key">1</span>

aws cloudwatch put-metric-alarm \
  --alarm-name <span class="str">CIS-3.5-CloudTrailChanges</span> \
  --metric-name <span class="str">CloudTrailChangeCount</span> \
  --namespace <span class="str">CISBenchmark</span> \
  --statistic <span class="str">Sum</span> --period <span class="key">300</span> --threshold <span class="key">1</span> \
  --comparison-operator <span class="str">GreaterThanOrEqualToThreshold</span> \
  --evaluation-periods <span class="key">1</span> \
  --alarm-actions arn:aws:sns:us-east-1:<span class="hl2">ACCOUNT_ID</span>:SecurityAlerts</pre>
            </div>
          </div>
        </div>
      </div>
      <div class="lab-step">
        <div class="step-num-wrap"><div class="step-num">4</div><div class="step-connector"></div></div>
        <div class="step-content">
          <div class="step-title">Build CloudWatch SIEM Dashboard <span style="font-size:12px;color:var(--muted);font-family:'IBM Plex Mono',monospace">~10 min</span></div>
          <div class="step-body">
            <ol>
              <li>CloudWatch Console ‚Üí Dashboards ‚Üí Create dashboard ‚Üí <code>SecurityOperations</code></li>
              <li>Add widget ‚Üí Alarm status ‚Üí select both CIS alarms (gives red/green at a glance)</li>
              <li>Add widget ‚Üí Logs table ‚Üí Logs Insights query ‚Üí paste the root account usage query from Lesson 3, time range 24h</li>
              <li>Add widget ‚Üí Logs table ‚Üí paste the IAM privilege escalation query from Lesson 3</li>
              <li>Add widget ‚Üí Number ‚Üí metric <code>CISBenchmark/RootAccountUsageCount</code> sum 7d (should be 0)</li>
              <li>Screenshot the dashboard ‚Äî this is your SIEM home screen portfolio artefact</li>
            </ol>
          </div>
        </div>
      </div>
      <div class="lab-step">
        <div class="step-num-wrap"><div class="step-num">5</div></div>
        <div class="step-content">
          <div class="step-title">Run a Logs Insights Hunt + Commit <span style="font-size:12px;color:var(--muted);font-family:'IBM Plex Mono',monospace">~10 min</span></div>
          <div class="step-body">
            <ol>
              <li>CloudWatch ‚Üí Logs Insights ‚Üí select log group ‚Üí run the "top API callers" query from Lesson 3</li>
              <li>Export the results as CSV ‚Üí save as <code>portfolio/week4/day22-api-baseline.csv</code></li>
              <li>Screenshot the dashboard + Logs Insights results</li>
            </ol>
            <div class="code-block">
              <div class="code-header"><span class="code-lang">bash ‚Äî commit artefacts</span><button class="copy-btn" onclick="copyCode(this)">copy</button></div>
              <pre>git add portfolio/week4/ screenshots/day-22*.png
git commit -m <span class="str">"Day 22: Multi-region CloudTrail, CIS 3.3+3.5 alarms, SIEM dashboard"</span>
git push</pre>
            </div>
          </div>
        </div>
      </div>
    </div>
    <h2 style="font-family:'DM Serif Display',serif;font-size:20px;color:#e4eaf6;margin:32px 0 16px;font-weight:400">Lab Checklist</h2>
    <div class="checklist-progress"><div class="checklist-progress-bar"><div class="checklist-progress-fill" id="cl-fill"></div></div><span class="checklist-progress-label" id="cl-label">0 / 7</span></div>
    <div class="checklist">
      <div class="check-item" onclick="toggleCheck(this,0)"><div class="check-box">‚úì</div><div class="check-text">Multi-region CloudTrail created with CloudWatch Logs delivery to <code>/aws/cloudtrail/security-audit</code></div></div>
      <div class="check-item" onclick="toggleCheck(this,1)"><div class="check-box">‚úì</div><div class="check-text">Log file validation enabled ‚Äî trail status shows validation active</div></div>
      <div class="check-item" onclick="toggleCheck(this,2)"><div class="check-box">‚úì</div><div class="check-text">SNS <code>SecurityAlerts</code> topic created + email subscription confirmed</div></div>
      <div class="check-item" onclick="toggleCheck(this,3)"><div class="check-box">‚úì</div><div class="check-text">CIS 3.3 alarm (root account usage) ‚Äî status OK in CloudWatch</div></div>
      <div class="check-item" onclick="toggleCheck(this,4)"><div class="check-box">‚úì</div><div class="check-text">CIS 3.5 alarm (CloudTrail changes) ‚Äî status OK in CloudWatch</div></div>
      <div class="check-item" onclick="toggleCheck(this,5)"><div class="check-box">‚úì</div><div class="check-text">SecurityOperations dashboard built with alarm widgets + 2 Logs Insights queries</div></div>
      <div class="check-item" onclick="toggleCheck(this,6)"><div class="check-box">‚úì</div><div class="check-text">Dashboard screenshot + API baseline CSV committed to portfolio/week4/</div></div>
    </div>
    <div class="lesson-nav-footer"><button class="prev-btn" onclick="prev()">‚Üê Previous</button><button class="next-btn lab-btn" onclick="finish()">Complete Day 22 ‚úì</button></div>
  </div>

  <!-- COMPLETION -->
  <div class="lesson-pane" id="pane-complete">
    <div class="completion-card">
      <span class="completion-icon">üîç</span>
      <h1>Day 22 Complete</h1>
      <p>You've built your security observation layer ‚Äî CloudTrail capturing every API call, CloudWatch Logs Insights for hunting, and automated CIS alarms firing within minutes of a detection. Tomorrow: GuardDuty threat intelligence.</p>
      <div class="score-pill"><span>‚ö°</span> Quiz: <span id="score-val">‚Äî</span></div><br>
      <div class="lab-score-pill"><span>üî¨</span> Lab: <span id="lab-score-val">‚Äî</span> complete</div>
      <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
        <a href="../index.html" style="text-decoration:none"><button class="prev-btn">‚Üê Course Index</button></a>
        <a href="day-23.html" style="text-decoration:none"><button class="next-btn">Day 23 ‚Üí</button></a>
      </div>
    </div>
  </div>
</div>
</div>
<script src="csm-core.js"></script>
<script>
initPage({
  storageKey: 'csm-day22',
  total: 5,
  quizCount: 4,
  checkTotal: 7,
  titles: ['Why Logging Is Your Security Brain','CloudTrail: The AWS API Audit Log','CloudWatch Logs Insights: Querying at Scale','Detection Engineering: Alarms & Metrics','Hands-on: Multi-Region Trail + SIEM Dashboard'],
  fb: {
  0:{good:"Correct ‚Äî and this distinction is critical for incident response. CloudTrail records the API call metadata: who made the call (IAM identity ARN), what they called (s3:GetObject), which resource (bucket/key ARN), when (UTC timestamp), and from where (source IP). It does NOT record the content of the S3 object. You know the file was accessed but not what was in it ‚Äî which is why data classification (Macie) matters. To know what was taken, you need to know what was in the bucket at that time.",bad:"Not quite. Option C is partially true but misleading ‚Äî S3 GetObject IS a data event, but by default CloudTrail doesn't log it. You need to explicitly enable S3 data events in your event selectors. The key point is: even with data events enabled, CloudTrail records the API call metadata only (bucket, key name, identity, IP, time) ‚Äî NOT the object content. You'd know which files were accessed but not what data they contained."},
  1:{good:"Correct. Management events capture bucket-level control-plane operations: CreateBucket, DeleteBucket, PutBucketPolicy, PutBucketAcl. They do NOT capture object-level operations. To log GetObject, PutObject, and DeleteObject calls, you must explicitly add an S3 data event selector to your trail. This is a critical gap in most default CloudTrail configurations ‚Äî and exactly what was missing in the Capital One breach investigation. Always enable S3 data events for buckets holding sensitive data.",bad:"Not quite. S3 data events (GetObject, PutObject, DeleteObject) are NOT included in management events. They're a separate event type requiring an explicit data event selector in your trail configuration. Without data events, CloudTrail only records bucket-level management operations. You would have no record of which specific objects were accessed, only that the bucket exists. This is a common gap that leaves security teams blind during S3 data breach investigations."},
  2:{good:"Correct. Zero results is only meaningful if the logging pipeline is verified end-to-end: (1) the trail was active during the entire period, (2) logs were delivered to the correct CloudWatch Log Group, (3) there were no delivery failures, (4) your query is pointing at the right log group. Always validate the pipeline before concluding absence of activity. Run a test query for known events (like your own console logins) to confirm the logs are flowing and the query syntax is correct.",bad:"Not quite. Zero results from a Logs Insights query means no matching events were found in the logs that were delivered. It doesn't guarantee there was no root account activity ‚Äî the trail could have been stopped, logs could be in a different log group, or delivery could have failed silently. Always validate the logging pipeline by running queries for known events before drawing security conclusions from zero results."},
  3:{good:"Correct. CloudWatch metric filters evaluate log data in near real-time, but alarms are assessed at the end of each evaluation period. With a 5-minute period, the alarm will evaluate the metric within the next 5-minute window after the event. Add a small delivery delay for CloudTrail logs to reach CloudWatch (typically 5-15 minutes), so the realistic detection window is within 10-20 minutes of the event. For a Critical alarm like root account usage, this is well within an acceptable MTTR for a 3 AM incident.",bad:"Not quite. CloudWatch alarms don't fire instantaneously on each log event. The metric filter continuously counts matching log lines, and the alarm evaluates that count at the end of each period window (5 minutes in this case). Add CloudTrail's log delivery latency (typically 5-15 minutes) and the total detection window is 10-20 minutes after the event. Real-time firing would require a different pattern (EventBridge + Lambda) which we cover in Day 26."}
}
});
</script>
</body>
</html>
