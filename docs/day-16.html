<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Day 16 ‚Äî Data Protection: S3 + KMS</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="shared.css">
</head>
<body>
<div class="shell">
<nav class="sidebar">
  <div class="sidebar-header">
    <div class="day-badge">Week 3 ¬∑ Day 16</div>
    <h2>Data Protection:<br>S3 + KMS</h2>
    <div class="sidebar-meta"><span class="chip">S3</span><span class="chip">KMS</span><span class="chip">CMK</span><span class="chip">4 lessons</span><span class="chip">1 lab</span></div>
  </div>
  <div class="sidebar-back">
    <a class="back-index" href="../index.html">
      <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M7.5 2L3.5 6L7.5 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      Course Index
    </a>
    <div class="week-jumps-label">Jump to week</div>
    <div class="week-jumps">
      <a class="week-jump wj1" href="../index.html#week-1">W1</a>
      <a class="week-jump wj2" href="../index.html#week-2">W2</a>
      <a class="week-jump wj3" href="../index.html#week-3">W3</a>
      <a class="week-jump wj4" href="../index.html#week-4">W4</a>
    </div>
    <div class="day-nav-label">Week 3 days</div>
    <div class="day-nav">
      <a class="day-link" href="day-15.html">D15</a>
      <a class="day-link current" href="day-16.html">D16</a>
      <a class="day-link" href="day-17.html">D17</a>
      <a class="day-link" href="day-18.html">D18</a>
      <a class="day-link" href="day-19.html">D19</a>
      <a class="day-link" href="day-20.html">D20</a>
      <a class="day-link" href="day-21.html">D21</a>
    </div>
  </div>

  <div class="lesson-nav">
    <div class="nav-group-label">Lessons</div>
    <div class="nav-item active" onclick="goTo(0)"><span class="nav-num">01</span><span class="nav-label">Why Encryption at Rest Matters</span><span class="nav-check">‚úì</span></div>
    <div class="nav-item" onclick="goTo(1)"><span class="nav-num">02</span><span class="nav-label">KMS Key Types: SSE-S3, SSE-KMS, CMK</span><span class="nav-check">‚úì</span></div>
    <div class="nav-item" onclick="goTo(2)"><span class="nav-num">03</span><span class="nav-label">KMS Key Policies & Access Control</span><span class="nav-check">‚úì</span></div>
    <div class="nav-item" onclick="goTo(3)"><span class="nav-num">04</span><span class="nav-label">S3 Bucket Policies & Encryption Enforcement</span><span class="nav-check">‚úì</span></div>
    <div class="nav-group-label" style="margin-top:8px">Lab</div>
    <div class="nav-item lab-item" onclick="goTo(4)"><span class="nav-num" style="color:var(--lab)">üî¨</span><span class="nav-label">Hands-on: CMK + Encrypted S3 + Enforce Policy</span><span class="nav-check">‚úì</span></div>
  </div>
  <div class="sidebar-footer">
    <div class="progress-label"><span>Progress</span><span id="progress-pct">0 / 5</span></div>
    <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
  </div>
</nav>
<div class="main">
  <div class="lesson-topbar">
    <div class="lesson-crumb">Day 16 &nbsp;/&nbsp; <span id="topbar-title">Why Encryption at Rest Matters</span></div>
    <div class="nav-arrows">
      <button class="arrow-btn" id="btn-prev" onclick="prev()" disabled>‚Üê Prev</button>
      <button class="arrow-btn" id="btn-next" onclick="next()">Next ‚Üí</button>
    </div>
  </div>

  <!-- LESSON 1 -->
  <div class="lesson-pane active" id="pane-0">
    <div class="lesson-tag tag-security">Data Protection ¬∑ Foundational</div>
    <h1>Why Encryption<br><em>at Rest Matters</em></h1>
    <p>Network controls like VPCs and Security Groups protect data in transit. But what happens when an attacker gets past them ‚Äî or when a hard drive is physically removed from a data centre? That's the problem encryption at rest solves.</p>
    <p>When data is encrypted at rest, <strong>storage media becomes worthless without the key</strong>. An attacker who exfiltrates a raw S3 object or database file gets unintelligible ciphertext. Encryption at rest is also mandated by virtually every compliance framework: PCI DSS, HIPAA, SOC 2, GDPR, and more.</p>
    <div class="callout breach">
      <div class="callout-title">‚ö† Real Breach ‚Äî Code Spaces (2014)</div>
      An attacker gained access to Code Spaces' AWS console, deleted EC2 instances, S3 buckets, EBS snapshots, and machine images ‚Äî effectively destroying the company in hours. The catastrophic data loss was compounded by the fact that S3 backups were in the same account with no encryption or access separation. The company shut down days later. Encryption + separate KMS key ownership would not have prevented deletion, but it would have made exfiltrated data useless.
    </div>
    <p>AWS provides a clear data-protection hierarchy. Your goal is to always operate at least at <strong>SSE-KMS with a Customer Managed Key (CMK)</strong>:</p>
    <div class="enc-tier-grid">
      <div class="enc-tier">
        <div class="enc-tier-label">Level 1 ‚Äî Minimum</div>
        <div class="enc-tier-name">SSE-S3</div>
        <div class="enc-tier-desc">AWS manages every key. You have zero control or audit visibility into who used the key.</div>
      </div>
      <div class="enc-tier highlight">
        <div class="enc-tier-label">Level 2 ‚Äî Recommended</div>
        <div class="enc-tier-name">SSE-KMS (CMK)</div>
        <div class="enc-tier-desc">You own the key. Full CloudTrail audit of every decrypt. IAM + key policy access control. Key rotation policy.</div>
      </div>
      <div class="enc-tier">
        <div class="enc-tier-label">Level 3 ‚Äî Regulated</div>
        <div class="enc-tier-name">SSE-C / CSE</div>
        <div class="enc-tier-desc">Customer-supplied or client-side encryption. Key never leaves your HSM. Required for some FedRAMP/DoD workloads.</div>
      </div>
    </div>
    <div class="callout insight">
      <div class="callout-title">üí° Encryption ‚â† Access Control</div>
      Encryption at rest protects against physical media theft and raw storage exfiltration. It does <em>not</em> protect against authorised users or roles with IAM permission to decrypt. You still need bucket policies, IAM least-privilege, and Macie (Day 17) for complete data protection. Encryption is one layer of a defence-in-depth strategy.
    </div>
    <div class="kcheck">
      <div class="kcheck-label">Knowledge Check</div>
      <div class="kcheck-q">Your S3 bucket stores customer PCI data encrypted with SSE-S3 (AWS-managed keys). A junior developer's IAM credentials are stolen. The attacker uses the credentials to call <code>s3:GetObject</code>. Is the encryption protecting you here?</div>
      <div class="kcheck-options">
        <button class="kcheck-opt" onclick="check(this,false,0)"><span class="opt-key">A</span>Yes ‚Äî SSE-S3 means no one without the key can read the objects, including the attacker</button>
        <button class="kcheck-opt" onclick="check(this,true,0)"><span class="opt-key">B</span>No ‚Äî the attacker is using valid IAM credentials. S3 decrypts objects transparently for any authorised API call. The encryption only protects against raw storage access, not IAM-authenticated API calls</button>
        <button class="kcheck-opt" onclick="check(this,false,0)"><span class="opt-key">C</span>Partially ‚Äî SSE-S3 adds a second authentication step before objects can be downloaded</button>
        <button class="kcheck-opt" onclick="check(this,false,0)"><span class="opt-key">D</span>Yes ‚Äî PCI data buckets require MFA to decrypt, which the attacker doesn't have</button>
      </div>
      <div class="kcheck-feedback" id="fb-0"></div>
    </div>
    <div class="lesson-nav-footer">
      <button class="prev-btn" disabled>‚Üê Previous</button>
      <button class="next-btn" onclick="next()">Next Lesson ‚Üí</button>
    </div>
  </div>

  <!-- LESSON 2 -->
  <div class="lesson-pane" id="pane-1">
    <div class="lesson-tag tag-concept">KMS Deep Dive ¬∑ Foundational</div>
    <h1>KMS Key Types:<br><em>SSE-S3, SSE-KMS & CMK</em></h1>
    <p><strong>Objective:</strong> Understand the three S3 server-side encryption modes, when to use each, and exactly how KMS Customer Managed Keys give you operational control over data access.</p>
    <table class="styled-table">
      <thead>
        <tr><th>Mode</th><th>Key ownership</th><th>CloudTrail log</th><th>Key rotation</th><th>Cross-account?</th></tr>
      </thead>
      <tbody>
        <tr><td>SSE-S3</td><td>AWS-managed (invisible)</td><td>No key events</td><td>AWS automatic</td><td>No</td></tr>
        <tr><td>SSE-KMS (AWS managed)</td><td>AWS-managed per service</td><td>Yes ‚Äî via KMS logs</td><td>AWS automatic</td><td>No</td></tr>
        <tr><td>SSE-KMS (CMK) ‚úì</td><td><strong>You own the key</strong></td><td>Yes ‚Äî every decrypt</td><td>You configure</td><td>Yes</td></tr>
        <tr><td>SSE-C</td><td>You supply per-request</td><td>No</td><td>Your responsibility</td><td>N/A</td></tr>
      </tbody>
    </table>
    <p>When you use a <strong>Customer Managed Key (CMK)</strong>, every <code>s3:GetObject</code> call triggers a KMS <code>Decrypt</code> API call ‚Äî and that decrypt event is logged in CloudTrail with the caller's identity. This gives you a <strong>complete audit trail of who accessed what data, when</strong>.</p>
    <div class="flow-steps">
      <div class="flow-step">
        <div class="flow-num">1</div>
        <div class="flow-body"><strong>Upload</strong> ‚Äî S3 receives the object, calls KMS <code>GenerateDataKey</code> using your CMK. KMS returns a plaintext data key + an encrypted copy.</div>
      </div>
      <div class="flow-step">
        <div class="flow-num">2</div>
        <div class="flow-body"><strong>Store</strong> ‚Äî S3 encrypts the object with the plaintext data key (AES-256), then discards the plaintext key. Only the encrypted data key is stored alongside the object.</div>
      </div>
      <div class="flow-step">
        <div class="flow-num">3</div>
        <div class="flow-body"><strong>Download</strong> ‚Äî S3 calls KMS <code>Decrypt</code> to unwrap the data key. If the caller's IAM identity is denied by the KMS key policy, the decrypt fails and <code>s3:GetObject</code> returns <code>AccessDenied</code> ‚Äî even if the IAM policy allows S3 access.</div>
      </div>
      <div class="flow-step">
        <div class="flow-num">4</div>
        <div class="flow-body"><strong>Audit</strong> ‚Äî CloudTrail logs the KMS <code>Decrypt</code> call with the IAM principal, key ARN, and timestamp. This is your evidence chain for compliance and incident investigation.</div>
      </div>
    </div>
    <div class="callout tip">
      <div class="callout-title">‚úì Key Rotation Best Practice</div>
      Enable automatic key rotation on every CMK: KMS ‚Üí Key ‚Üí Key rotation ‚Üí Enable. AWS rotates the backing key material annually. Old versions are retained for decryption of existing objects, but new objects use the new key material. This limits the blast radius of a compromised key ‚Äî data encrypted before the rotation remains readable, but any new data encrypted after a key compromise is safe.
    </div>
    <div class="kcheck">
      <div class="kcheck-label">Knowledge Check</div>
      <div class="kcheck-q">A developer has <code>s3:GetObject</code> permission on a bucket encrypted with your CMK, but does NOT have <code>kms:Decrypt</code> permission on the CMK. What happens when they try to download an object?</div>
      <div class="kcheck-options">
        <button class="kcheck-opt" onclick="check(this,false,1)"><span class="opt-key">A</span>The download succeeds ‚Äî S3 handles decryption internally and the IAM policy on S3 is all that matters</button>
        <button class="kcheck-opt" onclick="check(this,false,1)"><span class="opt-key">B</span>The download succeeds but returns ciphertext ‚Äî the developer must decrypt it locally</button>
        <button class="kcheck-opt" onclick="check(this,true,1)"><span class="opt-key">C</span>The download fails with AccessDenied ‚Äî S3 must call KMS Decrypt to serve the object, and that KMS call is denied because the developer lacks kms:Decrypt permission</button>
        <button class="kcheck-opt" onclick="check(this,false,1)"><span class="opt-key">D</span>The download succeeds but KMS logs an unauthorised access warning in CloudTrail</button>
      </div>
      <div class="kcheck-feedback" id="fb-1"></div>
    </div>
    <div class="lesson-nav-footer">
      <button class="prev-btn" onclick="prev()">‚Üê Previous</button>
      <button class="next-btn" onclick="next()">Next Lesson ‚Üí</button>
    </div>
  </div>

  <!-- LESSON 3 -->
  <div class="lesson-pane" id="pane-2">
    <div class="lesson-tag tag-security">Access Control ¬∑ Intermediate</div>
    <h1>KMS Key Policies<br><em>& Access Control</em></h1>
    <p><strong>Objective:</strong> Understand how KMS key policies work, how they differ from IAM policies, and how to write a least-privilege key policy that separates administration from usage.</p>
    <p>Every KMS key has a <strong>key policy</strong> ‚Äî a resource-based policy (like an S3 bucket policy) that controls who can use and administer the key. Unlike most AWS resources, <strong>IAM policies alone cannot grant KMS access</strong>: the key policy must explicitly allow the principal, or delegate to IAM.</p>
    <div class="callout insight">
      <div class="callout-title">üí° The Two-Gate Model</div>
      To use a KMS key, a principal must pass <em>both</em> gates: (1) the key policy must grant access (or delegate to IAM), AND (2) the IAM policy must grant <code>kms:Decrypt</code> / <code>kms:GenerateDataKey</code>. This separation means you can grant broad IAM KMS permissions without risk ‚Äî the key policy is the final authority.
    </div>
    <div class="code-block">
      <div class="code-header"><span class="code-lang">JSON ‚Äî Least-Privilege CMK Key Policy</span><button class="copy-btn" onclick="copyCode(this)">copy</button></div>
      <pre>{
  <span class="key">"Version"</span>: <span class="str">"2012-10-17"</span>,
  <span class="key">"Statement"</span>: [
    {
      <span class="comment">// 1. Root account: full key administration (break-glass)</span>
      <span class="hl">"Sid"</span>: <span class="str">"RootAdminAccess"</span>,
      <span class="hl">"Effect"</span>: <span class="str">"Allow"</span>,
      <span class="hl">"Principal"</span>: { <span class="str">"AWS"</span>: <span class="str">"arn:aws:iam::123456789012:root"</span> },
      <span class="hl">"Action"</span>: <span class="str">"kms:*"</span>,
      <span class="hl">"Resource"</span>: <span class="str">"*"</span>
    },
    {
      <span class="comment">// 2. Key admins: manage the key, cannot use it to encrypt/decrypt</span>
      <span class="hl">"Sid"</span>: <span class="str">"KeyAdmins"</span>,
      <span class="hl">"Effect"</span>: <span class="str">"Allow"</span>,
      <span class="hl">"Principal"</span>: { <span class="str">"AWS"</span>: <span class="str">"arn:aws:iam::123456789012:role/SecurityOps"</span> },
      <span class="hl">"Action"</span>: [
        <span class="str">"kms:Create*"</span>, <span class="str">"kms:Describe*"</span>, <span class="str">"kms:Enable*"</span>,
        <span class="str">"kms:List*"</span>, <span class="str">"kms:Put*"</span>, <span class="str">"kms:Update*"</span>,
        <span class="str">"kms:Revoke*"</span>, <span class="str">"kms:Disable*"</span>, <span class="str">"kms:Delete*"</span>,
        <span class="str">"kms:ScheduleKeyDeletion"</span>, <span class="str">"kms:CancelKeyDeletion"</span>
      ],
      <span class="hl">"Resource"</span>: <span class="str">"*"</span>
    },
    {
      <span class="comment">// 3. App role: use the key only (encrypt/decrypt for S3)</span>
      <span class="hl">"Sid"</span>: <span class="str">"AppUsage"</span>,
      <span class="hl">"Effect"</span>: <span class="str">"Allow"</span>,
      <span class="hl">"Principal"</span>: { <span class="str">"AWS"</span>: <span class="str">"arn:aws:iam::123456789012:role/AppServer"</span> },
      <span class="hl">"Action"</span>: [
        <span class="str">"kms:Decrypt"</span>, <span class="str">"kms:GenerateDataKey"</span>,
        <span class="str">"kms:DescribeKey"</span>
      ],
      <span class="hl">"Resource"</span>: <span class="str">"*"</span>
    }
  ]
}</pre>
    </div>
    <div class="callout warning">
      <div class="callout-title">‚ö† Never Delete a KMS Key Immediately</div>
      KMS enforces a minimum 7-day waiting period before key deletion. This is intentional ‚Äî once a key is deleted, all data encrypted with it is permanently unrecoverable. Always disable a key first, monitor for decrypt errors for 7‚Äì30 days, then schedule deletion. One deleted key can cause catastrophic, unrecoverable data loss.
    </div>
    <div class="kcheck">
      <div class="kcheck-label">Knowledge Check</div>
      <div class="kcheck-q">Your CMK's key policy grants access only to the root account. An IAM role <code>AppServer</code> has <code>kms:Decrypt</code> and <code>kms:GenerateDataKey</code> in its IAM policy. Can <code>AppServer</code> use the key to encrypt S3 objects?</div>
      <div class="kcheck-options">
        <button class="kcheck-opt" onclick="check(this,false,2)"><span class="opt-key">A</span>Yes ‚Äî IAM policies are sufficient for KMS access. The key policy is only needed for administrative actions like deletion</button>
        <button class="kcheck-opt" onclick="check(this,true,2)"><span class="opt-key">B</span>No ‚Äî the key policy only grants access to root. Since AppServer is not listed in the key policy (and the policy doesn't delegate to IAM), the KMS call is denied regardless of the IAM policy</button>
        <button class="kcheck-opt" onclick="check(this,false,2)"><span class="opt-key">C</span>Yes ‚Äî root account access in the key policy means all principals in the account inherit access</button>
        <button class="kcheck-opt" onclick="check(this,false,2)"><span class="opt-key">D</span>Yes ‚Äî the IAM policy grants kms:Decrypt which overrides the key policy restriction</button>
      </div>
      <div class="kcheck-feedback" id="fb-2"></div>
    </div>
    <div class="lesson-nav-footer">
      <button class="prev-btn" onclick="prev()">‚Üê Previous</button>
      <button class="next-btn" onclick="next()">Next Lesson ‚Üí</button>
    </div>
  </div>

  <!-- LESSON 4 -->
  <div class="lesson-pane" id="pane-3">
    <div class="lesson-tag tag-ops">Enforcement ¬∑ Intermediate</div>
    <h1>S3 Bucket Policies &<br><em>Encryption Enforcement</em></h1>
    <p><strong>Objective:</strong> Enforce that all objects uploaded to a bucket <em>must</em> use your CMK ‚Äî and deny any upload that uses no encryption or the wrong key. This closes the gap between "encryption is available" and "encryption is mandatory".</p>
    <p>Enabling SSE-KMS encryption on a bucket sets the <strong>default</strong>. It does not prevent someone with <code>s3:PutObject</code> from uploading an unencrypted object and overriding the default. You need a bucket policy deny condition to make it mandatory.</p>
    <div class="code-block">
      <div class="code-header"><span class="code-lang">JSON ‚Äî Bucket Policy: Enforce CMK Encryption</span><button class="copy-btn" onclick="copyCode(this)">copy</button></div>
      <pre>{
  <span class="key">"Version"</span>: <span class="str">"2012-10-17"</span>,
  <span class="key">"Statement"</span>: [
    {
      <span class="comment">// Deny any PutObject that isn't using SSE-KMS</span>
      <span class="hl">"Sid"</span>: <span class="str">"DenyUnencryptedUploads"</span>,
      <span class="hl">"Effect"</span>: <span class="str">"Deny"</span>,
      <span class="hl">"Principal"</span>: <span class="str">"*"</span>,
      <span class="hl">"Action"</span>: <span class="str">"s3:PutObject"</span>,
      <span class="hl">"Resource"</span>: <span class="str">"arn:aws:s3:::my-pci-bucket/*"</span>,
      <span class="hl2">"Condition"</span>: {
        <span class="str">"StringNotEquals"</span>: {
          <span class="str">"s3:x-amz-server-side-encryption"</span>: <span class="str">"aws:kms"</span>
        }
      }
    },
    {
      <span class="comment">// Additionally: enforce that ONLY your specific CMK is used</span>
      <span class="hl">"Sid"</span>: <span class="str">"DenyWrongKey"</span>,
      <span class="hl">"Effect"</span>: <span class="str">"Deny"</span>,
      <span class="hl">"Principal"</span>: <span class="str">"*"</span>,
      <span class="hl">"Action"</span>: <span class="str">"s3:PutObject"</span>,
      <span class="hl">"Resource"</span>: <span class="str">"arn:aws:s3:::my-pci-bucket/*"</span>,
      <span class="hl2">"Condition"</span>: {
        <span class="str">"StringNotEquals"</span>: {
          <span class="str">"s3:x-amz-server-side-encryption-aws-kms-key-id"</span>:
            <span class="str">"arn:aws:kms:us-east-1:123456789012:key/your-cmk-id"</span>
        }
      }
    },
    {
      <span class="comment">// Enforce HTTPS ‚Äî deny all non-TLS requests</span>
      <span class="hl">"Sid"</span>: <span class="str">"DenyHTTP"</span>,
      <span class="hl">"Effect"</span>: <span class="str">"Deny"</span>,
      <span class="hl">"Principal"</span>: <span class="str">"*"</span>,
      <span class="hl">"Action"</span>: <span class="str">"s3:*"</span>,
      <span class="hl">"Resource"</span>: [
        <span class="str">"arn:aws:s3:::my-pci-bucket"</span>,
        <span class="str">"arn:aws:s3:::my-pci-bucket/*"</span>
      ],
      <span class="hl2">"Condition"</span>: {
        <span class="str">"Bool"</span>: { <span class="str">"aws:SecureTransport"</span>: <span class="str">"false"</span> }
      }
    }
  ]
}</pre>
    </div>
    <div class="callout tip">
      <div class="callout-title">‚úì S3 Block Public Access ‚Äî Always On</div>
      Enable all four Block Public Access settings at the account level and per-bucket. This prevents any bucket policy or ACL from ever making objects public ‚Äî even if a misconfigured policy attempts it. This is a single-click, zero-cost control that prevents the most common S3 data exposure pattern.
    </div>
    <div class="kcheck">
      <div class="kcheck-label">Knowledge Check</div>
      <div class="kcheck-q">You've set SSE-KMS as the default encryption on your S3 bucket. A developer uploads a file using the AWS CLI without specifying an encryption header. What actually happens?</div>
      <div class="kcheck-options">
        <button class="kcheck-opt" onclick="check(this,false,3)"><span class="opt-key">A</span>The upload is rejected ‚Äî S3 requires an explicit encryption header when a default is configured</button>
        <button class="kcheck-opt" onclick="check(this,true,3)"><span class="opt-key">B</span>The upload succeeds and the object is encrypted with the default key ‚Äî BUT without a bucket policy deny condition, a developer could also override the default by explicitly specifying no encryption or a different key</button>
        <button class="kcheck-opt" onclick="check(this,false,3)"><span class="opt-key">C</span>The upload succeeds unencrypted ‚Äî the default only applies to objects uploaded through the console</button>
        <button class="kcheck-opt" onclick="check(this,false,3)"><span class="opt-key">D</span>The upload is encrypted with SSE-S3, not SSE-KMS ‚Äî the CLI ignores bucket default settings</button>
      </div>
      <div class="kcheck-feedback" id="fb-3"></div>
    </div>
    <div class="lesson-nav-footer">
      <button class="prev-btn" onclick="prev()">‚Üê Previous</button>
      <button class="next-btn lab-btn" onclick="next()">Start Lab ‚Üí</button>
    </div>
  </div>

  <!-- LAB -->
  <div class="lesson-pane lab-pane" id="pane-4">
    <div class="lesson-tag tag-lab">üî¨ Hands-On Lab</div>
    <h1>CMK + Encrypted S3<br><em>+ Enforce Policy</em></h1>
    <p>Create a Customer Managed Key with a least-privilege key policy, deploy an S3 bucket with CMK default encryption, and attach a bucket policy that enforces your CMK on every upload ‚Äî then verify and document the full chain.</p>
    <div class="callout lab-note"><div class="callout-title">‚ö° Cost Note</div>KMS CMK: $1.00/month per key + $0.03 per 10,000 API calls. For this lab you'll generate a few test API calls ‚Äî total cost under $0.01. <strong>Delete the key and bucket at the end</strong> using <code>week-3/labs/cleanup.sh</code>. Disable the key first; wait 7 days before scheduling deletion is enforced by AWS.</div>
    <div class="lab-steps">
      <div class="lab-step">
        <div class="step-num-wrap"><div class="step-num">1</div><div class="step-connector"></div></div>
        <div class="step-content">
          <div class="step-title">Create a Customer Managed Key (CMK) <span style="font-size:12px;color:var(--muted);font-family:'IBM Plex Mono',monospace">~10 min</span></div>
          <div class="step-body">
            <ol>
              <li>KMS Console ‚Üí <strong>Create key</strong> ‚Üí Symmetric ‚Üí Encrypt and decrypt</li>
              <li>Alias: <code>alias/sec-lab-s3-key</code></li>
              <li>Key administrators: your IAM user (for this lab)</li>
              <li>Key usage: your IAM user (for encrypt/decrypt)</li>
              <li>Review the generated key policy ‚Äî note the separation between admin actions and usage actions</li>
              <li>Enable <strong>Automatic key rotation</strong> ‚Üí save the key ARN in your notes</li>
            </ol>
          </div>
        </div>
      </div>
      <div class="lab-step">
        <div class="step-num-wrap"><div class="step-num">2</div><div class="step-connector"></div></div>
        <div class="step-content">
          <div class="step-title">Create an S3 Bucket with CMK Default Encryption <span style="font-size:12px;color:var(--muted);font-family:'IBM Plex Mono',monospace">~10 min</span></div>
          <div class="step-body">
            <ol>
              <li>S3 Console ‚Üí <strong>Create bucket</strong> ‚Üí Name: <code>sec-lab-encrypted-&lt;your-account-id&gt;</code></li>
              <li>Block all public access ‚Üí ‚úì enabled</li>
              <li>Default encryption ‚Üí <strong>SSE-KMS</strong> ‚Üí select <code>alias/sec-lab-s3-key</code></li>
              <li>Bucket versioning ‚Üí Enabled (best practice for data integrity)</li>
            </ol>
          </div>
        </div>
      </div>
      <div class="lab-step">
        <div class="step-num-wrap"><div class="step-num">3</div><div class="step-connector"></div></div>
        <div class="step-content">
          <div class="step-title">Attach Enforcement Bucket Policy <span style="font-size:12px;color:var(--muted);font-family:'IBM Plex Mono',monospace">~10 min</span></div>
          <div class="step-body">
            <p style="margin-bottom:10px">S3 Console ‚Üí Your bucket ‚Üí Permissions ‚Üí Bucket policy ‚Üí paste this policy (replace YOUR_CMK_ARN and YOUR_BUCKET_NAME):</p>
            <div class="code-block">
              <div class="code-header"><span class="code-lang">JSON ‚Äî Paste into S3 Bucket Policy Editor</span><button class="copy-btn" onclick="copyCode(this)">copy</button></div>
              <pre>{
  <span class="key">"Version"</span>: <span class="str">"2012-10-17"</span>,
  <span class="key">"Statement"</span>: [
    {
      <span class="hl">"Sid"</span>: <span class="str">"DenyUnencryptedUploads"</span>,
      <span class="hl">"Effect"</span>: <span class="str">"Deny"</span>, <span class="hl">"Principal"</span>: <span class="str">"*"</span>,
      <span class="hl">"Action"</span>: <span class="str">"s3:PutObject"</span>,
      <span class="hl">"Resource"</span>: <span class="str">"arn:aws:s3:::YOUR_BUCKET_NAME/*"</span>,
      <span class="hl2">"Condition"</span>: { <span class="str">"StringNotEquals"</span>: {
        <span class="str">"s3:x-amz-server-side-encryption"</span>: <span class="str">"aws:kms"</span> }}
    },
    {
      <span class="hl">"Sid"</span>: <span class="str">"DenyWrongKey"</span>,
      <span class="hl">"Effect"</span>: <span class="str">"Deny"</span>, <span class="hl">"Principal"</span>: <span class="str">"*"</span>,
      <span class="hl">"Action"</span>: <span class="str">"s3:PutObject"</span>,
      <span class="hl">"Resource"</span>: <span class="str">"arn:aws:s3:::YOUR_BUCKET_NAME/*"</span>,
      <span class="hl2">"Condition"</span>: { <span class="str">"StringNotEquals"</span>: {
        <span class="str">"s3:x-amz-server-side-encryption-aws-kms-key-id"</span>: <span class="str">"YOUR_CMK_ARN"</span> }}
    },
    {
      <span class="hl">"Sid"</span>: <span class="str">"DenyHTTP"</span>,
      <span class="hl">"Effect"</span>: <span class="str">"Deny"</span>, <span class="hl">"Principal"</span>: <span class="str">"*"</span>,
      <span class="hl">"Action"</span>: <span class="str">"s3:*"</span>,
      <span class="hl">"Resource"</span>: [<span class="str">"arn:aws:s3:::YOUR_BUCKET_NAME"</span>,
                    <span class="str">"arn:aws:s3:::YOUR_BUCKET_NAME/*"</span>],
      <span class="hl2">"Condition"</span>: { <span class="str">"Bool"</span>: {
        <span class="str">"aws:SecureTransport"</span>: <span class="str">"false"</span> }}
    }
  ]
}</pre>
            </div>
          </div>
        </div>
      </div>
      <div class="lab-step">
        <div class="step-num-wrap"><div class="step-num">4</div><div class="step-connector"></div></div>
        <div class="step-content">
          <div class="step-title">Verify: Test Enforcement & Check CloudTrail <span style="font-size:12px;color:var(--muted);font-family:'IBM Plex Mono',monospace">~10 min</span></div>
          <div class="step-body">
            <div class="code-block">
              <div class="code-header"><span class="code-lang">bash</span><button class="copy-btn" onclick="copyCode(this)">copy</button></div>
              <pre><span class="comment"># Test 1: Upload WITH correct CMK ‚Äî should succeed</span>
echo <span class="str">"pci-test-data"</span> > test.txt
aws s3 cp test.txt s3://<span class="hl">YOUR_BUCKET_NAME</span>/test-encrypted.txt \
  --sse aws:kms \
  --sse-kms-key-id <span class="hl">YOUR_CMK_ARN</span>
<span class="comment"># Expected: upload: ./test.txt to s3://... ‚úì</span>

<span class="comment"># Test 2: Upload WITHOUT encryption ‚Äî should be denied by bucket policy</span>
aws s3 cp test.txt s3://<span class="hl">YOUR_BUCKET_NAME</span>/test-unencrypted.txt
<span class="comment"># Expected: An error occurred (AccessDenied) ‚úì</span>

<span class="comment"># Test 3: Check CloudTrail for KMS Decrypt events</span>
<span class="comment"># CloudTrail ‚Üí Event history ‚Üí Filter: Event name = GenerateDataKey</span>
<span class="comment"># You'll see the upload event with your CMK ARN in the requestParameters</span></pre>
            </div>
          </div>
        </div>
      </div>
      <div class="lab-step">
        <div class="step-num-wrap"><div class="step-num">5</div></div>
        <div class="step-content">
          <div class="step-title">Document & Commit <span style="font-size:12px;color:var(--muted);font-family:'IBM Plex Mono',monospace">~5 min</span></div>
          <div class="step-body">
            <ol>
              <li>Screenshot: KMS key showing rotation enabled + key policy</li>
              <li>Screenshot: S3 bucket Properties ‚Üí Default encryption showing your CMK alias</li>
              <li>Screenshot: AccessDenied error from the unencrypted upload test</li>
              <li>Screenshot: CloudTrail <code>GenerateDataKey</code> event</li>
            </ol>
            <div class="code-block">
              <div class="code-header"><span class="code-lang">bash</span><button class="copy-btn" onclick="copyCode(this)">copy</button></div>
              <pre>git add screenshots/day-16-*.png
git commit -m <span class="str">"Day 16: CMK key policy, S3 SSE-KMS default, enforcement bucket policy"</span>
git push</pre>
            </div>
          </div>
        </div>
      </div>
    </div>
    <h2 style="font-family:'DM Serif Display',serif;font-size:20px;color:#e4eaf6;margin:32px 0 16px;font-weight:400">Lab Checklist</h2>
    <div class="checklist-progress"><div class="checklist-progress-bar"><div class="checklist-progress-fill" id="cl-fill"></div></div><span class="checklist-progress-label" id="cl-label">0 / 7</span></div>
    <div class="checklist">
      <div class="check-item" onclick="toggleCheck(this,0)"><div class="check-box">‚úì</div><div class="check-text">CMK created with alias <code>alias/sec-lab-s3-key</code> and automatic rotation enabled</div></div>
      <div class="check-item" onclick="toggleCheck(this,1)"><div class="check-box">‚úì</div><div class="check-text">Key policy separates admin actions (SecurityOps) from usage actions (AppServer)</div></div>
      <div class="check-item" onclick="toggleCheck(this,2)"><div class="check-box">‚úì</div><div class="check-text">S3 bucket created with SSE-KMS default encryption pointing to your CMK</div></div>
      <div class="check-item" onclick="toggleCheck(this,3)"><div class="check-box">‚úì</div><div class="check-text">Bucket policy: denies unencrypted uploads, wrong key, and non-HTTPS requests</div></div>
      <div class="check-item" onclick="toggleCheck(this,4)"><div class="check-box">‚úì</div><div class="check-text">Test: encrypted upload succeeds; unencrypted upload returns AccessDenied</div></div>
      <div class="check-item" onclick="toggleCheck(this,5)"><div class="check-box">‚úì</div><div class="check-text">CloudTrail shows <code>GenerateDataKey</code> event with your CMK ARN on the successful upload</div></div>
      <div class="check-item" onclick="toggleCheck(this,6)"><div class="check-box">‚úì</div><div class="check-text">4 screenshots committed to GitHub; cleanup script queued to disable CMK</div></div>
    </div>
    <div class="lesson-nav-footer"><button class="prev-btn" onclick="prev()">‚Üê Previous</button><button class="next-btn lab-btn" onclick="finish()">Complete Day 16 ‚úì</button></div>
  </div>

  <!-- COMPLETION -->
  <div class="lesson-pane" id="pane-complete">
    <div class="completion-card">
      <span class="completion-icon">üîë</span>
      <h1>Day 16 Complete</h1>
      <p>You now own your encryption keys and can prove every decrypt through CloudTrail. Day 17 adds Amazon Macie ‚Äî ML-powered PII discovery to find what sensitive data is actually sitting in those encrypted buckets.</p>
      <div class="score-pill"><span>‚ö°</span> Quiz: <span id="score-val">‚Äî</span></div><br>
      <div class="lab-score-pill"><span>üî¨</span> Lab: <span id="lab-score-val">‚Äî</span> complete</div>
      <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
        <a href="../index.html" style="text-decoration:none"><button class="prev-btn">‚Üê Course Index</button></a>
        <a href="day-17.html" style="text-decoration:none"><button class="next-btn">Day 17 ‚Üí</button></a>
      </div>
    </div>
  </div>
</div>
</div>
<script src="csm-core.js"></script>
<script>
initPage({
  storageKey: 'csm-day16',
  total: 5,
  quizCount: 4,
  checkTotal: 7,
  titles: ['Why Encryption at Rest Matters','KMS Key Types: SSE-S3, SSE-KMS & CMK','KMS Key Policies & Access Control','S3 Bucket Policies & Encryption Enforcement','Hands-on: CMK + Encrypted S3 + Enforce Policy'],
  fb: {
  0:{good:"Correct. SSE-S3 (and all server-side encryption) protects against raw storage access ‚Äî if someone extracts the physical hard drive or downloads raw EBS block data, they get ciphertext. But when an authorised principal calls s3:GetObject via the API with valid IAM credentials, S3 decrypts the object transparently before returning it. The IAM credential is the authentication factor ‚Äî encryption at rest doesn't add a second factor for API access.",bad:"Not quite. Server-side encryption protects data at the storage layer ‚Äî it does not add a second authentication factor for IAM API calls. When s3:GetObject is called with valid credentials, S3 decrypts the object before returning it. The encryption is invisible to any caller with valid IAM credentials. To protect against credential theft, you need IAM least-privilege, MFA, and short-lived credentials ‚Äî not just encryption."},
  1:{good:"Correct. With CMK encryption on S3, downloading an object is a two-step process: S3 must first call KMS Decrypt to unwrap the per-object data key, then use that key to decrypt the object. If the caller's identity is denied at the KMS Decrypt step ‚Äî either by the key policy or by the caller's IAM policy lacking kms:Decrypt ‚Äî the entire s3:GetObject request fails with AccessDenied, even though the s3:GetObject IAM permission exists. KMS acts as a second gate.",bad:"Not quite. CMK encryption on S3 means S3 must call KMS to decrypt the data key before it can serve the object. If the caller lacks kms:Decrypt permission in their IAM policy, that KMS call fails, and S3 cannot complete the s3:GetObject ‚Äî it returns AccessDenied. The IAM permission for S3 alone is insufficient when CMK encryption is in use. This is the key security advantage of CMK over SSE-S3."},
  2:{good:"Correct. KMS key policies are mandatory gatekeepers ‚Äî IAM policies alone are not sufficient. If the key policy only grants access to the root account and does not include a statement that delegates access to IAM (i.e., no statement like 'Allow IAM policies to control access'), then no IAM policy can grant usage of the key. AppServer's IAM policy is irrelevant ‚Äî the key policy doesn't list it as an allowed principal.",bad:"Not quite. This is the fundamental difference between KMS and most other AWS services. For most AWS resources, IAM policies alone are sufficient if no resource policy exists. For KMS, the key policy is always evaluated and must explicitly grant access or explicitly delegate to IAM. If the key policy only mentions root and no IAM delegation statement exists, no other IAM policy can grant key usage ‚Äî full stop."},
  3:{good:"Correct. Setting SSE-KMS as the default means objects uploaded without an encryption header will automatically be encrypted with the default key. However, 'default' can be overridden ‚Äî a caller can explicitly set a different encryption type (even 'none' with a bucket policy bypass attempt, or a different key). Without a bucket policy deny condition, the default is advisory, not mandatory. The deny condition is what makes the CMK requirement enforceable and auditable.",bad:"Not quite. When SSE-KMS is the bucket default, uploads without an explicit encryption header do get encrypted with the CMK. However, a caller can explicitly specify a different encryption setting (or attempt to bypass it) ‚Äî the default alone doesn't prevent this. You need the bucket policy deny conditions to ensure compliance is mandatory and cannot be overridden, which is what PCI DSS and other frameworks require."}
}
});
</script>
</body>
</html>
